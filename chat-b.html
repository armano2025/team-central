<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>יוסטון – שיעור על בסיס מקום פנוי</title>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet" />
  <meta name="theme-color" content="#0f172a" />

  <style>
    :root{
      --bg:#0b1220; --bg-grad-1:#0b1220; --bg-grad-2:#101a33;
      --glass:rgba(255,255,255,0.06); --glass-strong:rgba(255,255,255,0.12);
      --border:rgba(255,255,255,0.16); --text:#e5edf8; --muted:#9fb1c8;
      --primary:#4cb5ff; --primary-800:#1c78b2; --success:#10b981; --danger:#ef4444;
      --radius-xl:22px; --shadow-xl:0 20px 60px rgba(0,0,0,.35);
      --shadow-md:0 10px 30px rgba(0,0,0,.25); --blur:14px; --speed:.22s;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f3f6fb; --bg-grad-1:#eff4fb; --bg-grad-2:#e9f1fb;
        --glass:rgba(255,255,255,0.75); --glass-strong:rgba(255,255,255,0.9);
        --border:rgba(15,23,42,0.12); --text:#0f172a; --muted:#475569;
        --primary:#2563eb; --primary-800:#1e40af; --success:#059669; --danger:#dc2626;
      }
    }

    html,body{height:100%}
    body{
      margin:0; font-family:'Rubik',system-ui,-apple-system,Segoe UI,Arial,Helvetica;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 90% -10%, #153057 0%, transparent 60%),
        radial-gradient(1200px 800px at -10% 100%, #0a6bd9 0%, transparent 55%),
        linear-gradient(160deg, var(--bg-grad-1), var(--bg-grad-2));
      background-attachment: fixed;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    *{box-sizing:border-box}

    .wrap{max-width:880px;margin:28px auto;padding:0 16px}
    .card{
      position:relative; border-radius:var(--radius-xl);
      background:var(--glass); border:1px solid var(--border);
      box-shadow:var(--shadow-xl); backdrop-filter: blur(var(--blur));
      overflow:hidden;
    }
    .head{
      padding:20px 22px; display:flex; align-items:center; justify-content:space-between;
      background:
        linear-gradient(135deg, rgba(255,255,255,.08), rgba(255,255,255,0) 40%),
        linear-gradient(135deg, rgba(76,181,255,.22), rgba(76,181,255,0) 55%);
      border-bottom:1px solid var(--border);
    }
    .brand{display:flex; align-items:center; gap:12px}
    .logo{
      width:42px;height:42px;border-radius:50%;display:grid;place-items:center;
      background:linear-gradient(145deg, var(--primary), var(--primary-800));
      color:#fff;font-weight:700;letter-spacing:.5px;
      box-shadow:inset 0 0 10px rgba(255,255,255,.25), 0 10px 24px rgba(76,181,255,.35);
    }
    .title{font-weight:700;font-size:18px}

    .body{
      padding:22px; min-height:360px; display:grid; align-items:start;
      background:
        radial-gradient(800px 300px at 50% -30%, rgba(255,255,255,.08), transparent 60%),
        radial-gradient(700px 260px at 10% 120%, rgba(76,181,255,.10), transparent 60%);
    }
    #area{ max-width:680px; margin:0 auto; width:100% }

    .footer{
      display:flex; gap:10px; padding:14px 22px; border-top:1px solid var(--border);
      background:linear-gradient(0deg, rgba(255,255,255,.06), rgba(255,255,255,0));
    }

    .bubble{
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      border:1px solid var(--border);
      padding:14px 16px; border-radius:16px; margin:10px 0;
      line-height:1.8; box-shadow:var(--shadow-md);
    }
    .bubble strong{font-weight:700}
    .muted{color:var(--muted)}
    .ok{background:linear-gradient(180deg, rgba(16,185,129,.18), rgba(16,185,129,.10)); border-color:rgba(16,185,129,.45)}
    .err{background:linear-gradient(180deg, rgba(239,68,68,.20), rgba(239,68,68,.10)); border-color:rgba(239,68,68,.45)}

    .btn{
      width:100%; text-align:center; padding:13px 14px;
      border-radius:14px; border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,0.12), rgba(255,255,255,0.04));
      color:var(--text); font-size:16px; cursor:pointer;
      transition: transform var(--speed), box-shadow var(--speed), border-color var(--speed), background var(--speed);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      will-change: transform; user-select:none;
    }
    .btn:hover{
      transform: translateY(-1px);
      border-color: rgba(255,255,255,0.35);
      background:linear-gradient(180deg, rgba(255,255,255,0.18), rgba(255,255,255,0.06));
      box-shadow: 0 6px 16px rgba(0,0,0,0.2);
    }
    .btn:active{ transform: translateY(0) }
    .btn.primary{
      background:linear-gradient(145deg, var(--primary), var(--primary-800));
      color:#fff; border-color:transparent;
      box-shadow:0 8px 18px rgba(76,181,255,0.35);
    }
    .btn.primary:hover{ box-shadow:0 12px 24px rgba(76,181,255,0.45) }

    .input-wrap{display:grid; gap:8px}
    .input-wrap label{font-weight:700}
    .input{
      padding:12px 14px; border-radius:12px; border:1px solid var(--border);
      background:rgba(255,255,255,0.06); color:var(--text);
    }
    .textarea{
      padding:12px 14px; border-radius:12px; border:1px solid var(--border);
      background:rgba(255,255,255,0.06); color:var(--text); min-height:88px; resize:vertical;
    }

    @media (max-width:540px){
      .body{padding:16px}
      .footer{padding:12px 16px}
      .title{font-size:16px}
      .logo{width:38px;height:38px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="head">
        <div class="brand">
          <div class="logo">HB</div>
          <div class="title">יוסטון – שיעור על בסיס מקום פנוי</div>
        </div>
        <div></div>
      </div>

      <div class="body"><div id="area"></div></div>

      <div class="footer">
        <button id="backBtn" class="btn" type="button">חזרה</button>
        <button id="homeBtn" class="btn primary" type="button">לתפריט ראשי</button>
      </div>
    </div>
  </div>

  <script>
    /* ======== Web App URL (Apps Script) ======== */
    const SHEETS_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbwnNKY0BeO5N2O9oWmr8ltCHr9fVdDdrXsL_3erastx4qdEqhCz1mYAhkvZETF-86CGnw/exec';

    /* ======== Hebrew labels ======== */
    const HE = {
      path_on_demand: 'שיעור על בסיס מקום פנוי',
      cta_on_demand: 'שיעור חד־פעמי',
      source: 'יוסטון – אתר',
      status_new: 'חדש',
      plan: { group: 'קבוצה', triple: 'טריפל', private: 'פרטי' }
    };
    const PRICES = { group: 80, triple: 100, private: 160 }; // קבוצה=80₪

    /* ======== DOM ======== */
    const area    = document.getElementById('area');
    const backBtn = document.getElementById('backBtn');
    const homeBtn = document.getElementById('homeBtn');
    const clear   = () => area.innerHTML = '';

    /* ======== State ======== */
    const state = {
      history: [],
      data: {
        path: null,         // תמיד בעברית לענף זה
        subject: null,      // בעברית
        planType: null,     // 'group' | 'triple' | 'private'
        price: null,        // מספר
        availability: null, // טקסט חופשי
        message: null,      // מלל חופשי מהלקוח
        fullName: null,
        phone: null,
        cta: null
      }
    };
    const push  = (fn)=> state.history.push(fn);
    const goBack= ()=>{ if(state.history.length>1){ state.history.pop(); state.history.at(-1)(); } };
    const goHome= ()=>{ state.history.length=0; state.data={ path:null,subject:null,planType:null,price:null,availability:null,message:null,fullName:null,phone:null,cta:null }; step1(); };

    backBtn.onclick = goBack;
    homeBtn.onclick = goHome;

    /* ======== UI helpers ======== */
    function p(html){ const b=document.createElement('div'); b.className='bubble'; b.innerHTML=html; area.appendChild(b); return b; }
    function btn(text, onClick, cls='btn'){ const b=document.createElement('button'); b.className=cls; b.textContent=text; b.onclick=onClick; area.appendChild(b); return b; }

    function inputRow(label, type='text', id, {dir='rtl', textarea=false, placeholder=''}={}){
      const wrap=document.createElement('div'); wrap.className='bubble input-wrap';
      const l=document.createElement('label'); l.textContent=label;
      let i;
      if (textarea){
        i=document.createElement('textarea'); i.className='textarea';
      } else {
        i=document.createElement('input'); i.type=type; i.className='input';
        i.autocomplete=(id==='phone'?'tel':'name');
      }
      i.id=id; i.dir=dir; if(placeholder) i.placeholder=placeholder;
      wrap.appendChild(l); wrap.appendChild(i); area.appendChild(wrap);
      return i;
    }

    // phone helpers (IL)
    const normalizeILPhone = raw => {
      let p=(raw||'').toString().trim().replace(/[^\d+]/g,'');
      if(p.startsWith('+972')) p='0'+p.slice(4);
      if(p.startsWith('972'))  p='0'+p.slice(3);
      return p;
    };
    const validILPhone = p => /^0\d{8,9}$/.test(p||'');

    // breadcrumb
    function hebPlan(){ return HE.plan[state.data.planType] || ''; }
    function pathText(){
      const parts=[];
      if (state.data.planType) parts.push(`מסלול: ${hebPlan()} (${state.data.price}₪)`);
      if (state.data.subject)  parts.push(`מקצוע: ${state.data.subject}`);
      if (state.data.availability) parts.push(`זמינות: ${state.data.availability}`);
      if (state.data.message)  parts.push(`הודעה: ${state.data.message.slice(0,24)}${state.data.message.length>24?'…':''}`);
      if (state.data.fullName) parts.push(`שם: ${state.data.fullName}`);
      if (state.data.phone)    parts.push(`טלפון: ${state.data.phone}`);
      return parts.join(' • ');
    }
    function showPath(){
      const txt = pathText();
      if (!txt) return;
      const b = p(`<span class="muted">בחירה עד כה: ${txt}</span>`);
      b.style.fontSize='14px';
    }

    /* ======== send to Sheets ======== */
    async function sendLeadToSheet(payload){
      try{
        const res = await fetch(SHEETS_WEBAPP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' }, // מפחית Preflight
          body: JSON.stringify(payload)
        });
        const j = await res.json().catch(()=>({ok:false}));
        return j.ok === true || res.ok;
      }catch(e){
        console.error('Sheets webapp error', e);
        return false;
      }
    }

    /* ========== FLOW (ענף 1) ========== */

    // פתיח
    function step1(){
      clear(); push(step1);
      p('<strong>היי, אני יוסטון 👨‍🚀</strong><br>העוזר הדיגיטלי של מרכז בראונשטיין.<br><br>אני כאן כדי לעזור לך עד כמה שאוכל.');
      p('<strong>איך אוכל לעזור?</strong><br><span class="muted">בחרי אפשרות אחת מהכפתורים למטה.</span>');
      btn('ברשותי מנוי חודשי קבוע', ()=>{ /* ענף אחר */ alert('ענף מנויה קבועה – מתמקדים כעת בשיעור חד־פעמי'); });
      btn('פרטים על מנוי חודשי',     ()=>{ /* ענף אחר */ alert('ענף מנוי – מתמקדים כעת בשיעור חד־פעמי'); });
      btn('שיעור על בסיס מקום פנוי', ()=>{ state.data.path = HE.path_on_demand; stepOnDemandChoosePlan(); });
    }

    // בחירת מסלול חד־פעמי
    function stepOnDemandChoosePlan(){
      clear(); push(stepOnDemandChoosePlan);
      p('<strong>שיעור על בסיס מקום פנוי</strong><br><span class="muted">בחרי מסלול חד־פעמי.</span>');
      btn('קבוצה – עד 5 תלמידים – 80₪',  ()=>{ state.data.planType='group';  state.data.price=PRICES.group;  stepOnDemandSubject(); });
      btn('טריפל – עד 3 תלמידים – 100₪', ()=>{ state.data.planType='triple'; state.data.price=PRICES.triple; stepOnDemandSubject(); });
      btn('פרטי – 160₪',                   ()=>{ state.data.planType='private';state.data.price=PRICES.private;stepOnDemandSubject(); });
      btn('חזרה', goBack);
      showPath();
    }

    // בחירת מקצוע
    function stepOnDemandSubject(){
      clear(); push(stepOnDemandSubject);
      p('<strong>איזה מקצוע לשיעור החד־פעמי?</strong><br><span class="muted">בחרי מקצוע אחד.</span>');
      ['אנגלית','מתמטיקה','פיזיקה','שפה','אנגלית מדוברת'].forEach(l=>{
        btn(l, ()=>{ state.data.subject=l; stepOnDemandSummary(); });
      });
      btn('חזרה', goBack);
      showPath();
    }

    // סיכום ביניים + מעבר לזמינות
    function stepOnDemandSummary(){
      clear(); push(stepOnDemandSummary);
      const planHeb = hebPlan();
      p('<strong>סיכום</strong><br><span class="muted">בדקי שהכול נכון ואז נבקש זמינות.</span>');
      p(`שיעור חד־פעמי ב<strong>${state.data.subject}</strong> במסלול <strong>${planHeb}</strong> – <strong>${state.data.price}₪</strong>.`);
      btn('המשך לבחירת זמינות', stepAvailability, 'btn primary');
      btn('חזרה', goBack);
      showPath();
    }

    // זמינות (ימים ושעות)
    function stepAvailability(){
      clear(); push(stepAvailability);
      p('<strong>זמינות לשיעור</strong><br><span class="muted">כתבי ימים ושעות שנוח לך (למשל: “א׳–ג׳ 15:00–19:00, ו׳ בוקר”).</span>');
      const availInput = inputRow('ימי ושעות זמינות','text','availability',{dir:'rtl', textarea:true, placeholder:'לדוגמה: א׳–ג׳ 15:00–19:00; ו׳ בוקר'});
      btn('המשך למסר חופשי', ()=>{
        const txt = (availInput.value||'').trim();
        if (!txt){ p('אנא כתבי זמינות (ימים ושעות).').classList.add('err'); return; }
        state.data.availability = txt;
        stepFreeMessage();
      }, 'btn primary');
      btn('חזרה', goBack);
      showPath();
    }

    // מלל חופשי (חדש – לפני פרטי קשר)
    function stepFreeMessage(){
      clear(); push(stepFreeMessage);
      p('<strong>יש לך מסר או בקשה?</strong><br><span class="muted">ספרי לנו כל דבר שיעזור לנו לשבץ אותך נכון (אופציונלי).</span>');
      const msgInput = inputRow('הודעה חופשית (לא חובה)','text','message',{dir:'rtl', textarea:true, placeholder:'למשל: העדפה למורה מסוים/ת, רמת חומר, הערות מיוחדות'});
      btn('המשך לפרטי קשר', ()=>{
        const msg = (msgInput.value||'').trim();
        state.data.message = msg || ''; // אופציונלי
        stepCollectContact();
      }, 'btn primary');
      btn('חזרה', goBack);
      showPath();
    }

    // פרטי קשר (RTL)
    function stepCollectContact(){
      clear(); push(stepCollectContact);
      p('<strong>פרטי קשר</strong><br><span class="muted">מלאי שם מלא ומספר טלפון לחזרה.</span>');
      const nameInput  = inputRow('שם מלא','text','fullName',{dir:'rtl', placeholder:'לדוגמה: דנה לוי'});
      const phoneInput = inputRow('טלפון לחזרה','tel','phone',{dir:'rtl', placeholder:'לדוגמה: 0501234567'});

      btn('המשך לאישור סופי', ()=>{
        const fullName=(nameInput.value||'').trim();
        const phoneRaw = (phoneInput.value||'').trim();
        const phone = normalizeILPhone(phoneRaw);
        if(!fullName){ p('יש להזין שם מלא.').classList.add('err'); return; }
        if(!validILPhone(phone)){ p('מספר טלפון לא תקין (למשל 0501234567).').classList.add('err'); return; }
        state.data.fullName=fullName; state.data.phone=phone;
        stepFinalApprove();
      }, 'btn primary');
      btn('חזרה', goBack);
      showPath();
    }

    // אישור סופי
    function stepFinalApprove(){
      clear(); push(stepFinalApprove);
      const planHeb = hebPlan();
      p('<strong>נאשר שליחה למזכירות?</strong>');
      p([
        `מקצוע: <strong>${state.data.subject}</strong>`,
        `מסלול: <strong>${planHeb}</strong>`,
        `מחיר: <strong>${state.data.price}₪</strong>`,
        `זמינות: <strong>${state.data.availability}</strong>`,
        state.data.message ? `הודעה: <strong>${state.data.message}</strong>` : '',
        `שם: <strong>${state.data.fullName}</strong>`,
        `טלפון: <strong>${state.data.phone}</strong>`
      ].filter(Boolean).join('<br>'));

      btn('שליחה למזכירות', finalizeLead, 'btn primary');
      btn('חזרה', goBack);
      showPath();
    }

    // שליחה לשיטס (בעברית) + פידבק
    async function finalizeLead(){
      const payload = {
        path: HE.path_on_demand,                    // "שיעור על בסיס מקום פנוי"
        planType: HE.plan[state.data.planType],     // "קבוצה" | "טריפל" | "פרטי"
        price: `${state.data.price}₪`,              // "80₪" ...
        subject: state.data.subject,                // עברית
        availability: state.data.availability,      // טקסט חופשי
        message: state.data.message || '',          // טקסט חופשי (אופציונלי)
        fullName: state.data.fullName,              // RTL בתצוגה
        phone: state.data.phone,                    // בפועל נשלח כמספר ישראלי
        cta: HE.cta_on_demand,                      // "שיעור חד־פעמי"
        source: HE.source,                          // "יוסטון – אתר"
        status: HE.status_new,                      // "חדש"
        createdAt: new Date().toISOString()
      };

      clear();
      const sending = p('שולח בקשה...'); sending.classList.add('bubble');

      const okGS = await sendLeadToSheet(payload);
      clear();

      if(okGS){
        p('הבקשה נרשמה והועברה למזכירות 🛰️ נחזור אלייך בקרוב כדי לבדוק זמינות ולהשריין שיעור.').classList.add('ok');
        btn('לתפריט ראשי', goHome, 'btn primary');
        btn('פתח/י את הגיליון', ()=> window.open('https://docs.google.com/spreadsheets/d/1vQGA0aeXj9yncK2ZbuYZjrvQgPdpp7qN5FCxWBSAUd4/edit#gid=0','_blank','noopener'));
      }else{
        p('לא הצלחנו לשמור את הבקשה לגיליון. אפשר לנסות שוב או לפנות אלינו בוואטסאפ 050‑9570866.').classList.add('err');
        btn('נסי שוב', stepFinalApprove, 'btn');
        btn('לתפריט ראשי', goHome, 'btn primary');
      }
    }

    // Start
    step1();
  </script>
</body>
</html>