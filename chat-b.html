<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>יוסטון – שיעור על בסיס מקום פנוי</title>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet" />
  <meta name="theme-color" content="#0f172a" />

  <style>
    :root{
      --bg:#0b1220; --bg-grad-1:#0b1220; --bg-grad-2:#101a33;
      --glass:rgba(255,255,255,0.06); --glass-strong:rgba(255,255,255,0.12);
      --border:rgba(255,255,255,0.16); --text:#e5edf8; --muted:#9fb1c8;
      --primary:#4cb5ff; --primary-800:#1c78b2; --success:#10b981; --danger:#ef4444;
      --radius-xl:22px; --shadow-xl:0 20px 60px rgba(0,0,0,.35);
      --shadow-md:0 10px 30px rgba(0,0,0,.25); --blur:14px; --speed:.22s;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f3f6fb; --bg-grad-1:#eff4fb; --bg-grad-2:#e9f1fb;
        --glass:rgba(255,255,255,0.75); --glass-strong:rgba(255,255,255,0.9);
        --border:rgba(15,23,42,0.12); --text:#0f172a; --muted:#475569;
        --primary:#2563eb; --primary-800:#1e40af; --success:#059669; --danger:#dc2626;
      }
    }

    html,body{height:100%}
    body{
      margin:0; font-family:'Rubik',system-ui,-apple-system,Segoe UI,Arial,Helvetica;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 90% -10%, #153057 0%, transparent 60%),
        radial-gradient(1200px 800px at -10% 100%, #0a6bd9 0%, transparent 55%),
        linear-gradient(160deg, var(--bg-grad-1), var(--bg-grad-2));
      background-attachment: fixed;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    *{box-sizing:border-box}

    .wrap{max-width:880px;margin:28px auto;padding:0 16px}
    .card{
      position:relative; border-radius:var(--radius-xl);
      background:var(--glass); border:1px solid var(--border);
      box-shadow:var(--shadow-xl); backdrop-filter: blur(var(--blur));
      overflow:hidden;
    }
    .head{
      padding:20px 22px; display:flex; align-items:center; justify-content:space-between;
      background:
        linear-gradient(135deg, rgba(255,255,255,.08), rgba(255,255,255,0) 40%),
        linear-gradient(135deg, rgba(76,181,255,.22), rgba(76,181,255,0) 55%);
      border-bottom:1px solid var(--border);
    }
    .brand{display:flex; align-items:center; gap:12px}
    .logo{
      width:42px;height:42px;border-radius:50%;display:grid;place-items:center;
      background:linear-gradient(145deg, var(--primary), var(--primary-800));
      color:#fff;font-weight:700;letter-spacing:.5px;
      box-shadow:inset 0 0 10px rgba(255,255,255,.25), 0 10px 24px rgba(76,181,255,.35);
    }
    .title{font-weight:700;font-size:18px}

    .body{
      padding:22px; min-height:360px; display:grid; align-items:start;
      background:
        radial-gradient(800px 300px at 50% -30%, rgba(255,255,255,.08), transparent 60%),
        radial-gradient(700px 260px at 10% 120%, rgba(76,181,255,.10), transparent 60%);
    }
    #area{ max-width:680px; margin:0 auto; width:100% }

    .footer{
      display:flex; gap:10px; padding:14px 22px; border-top:1px solid var(--border);
      background:linear-gradient(0deg, rgba(255,255,255,.06), rgba(255,255,255,0));
    }

    .bubble{
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      border:1px solid var(--border);
      padding:14px 16px; border-radius:16px; margin:10px 0;
      line-height:1.8; box-shadow:var(--shadow-md);
    }
    .bubble strong{font-weight:700}
    .muted{color:var(--muted)}
    .ok{background:linear-gradient(180deg, rgba(16,185,129,.18), rgba(16,185,129,.10)); border-color:rgba(16,185,129,.45)}
    .err{background:linear-gradient(180deg, rgba(239,68,68,.20), rgba(239,68,68,.10)); border-color:rgba(239,68,68,.45)}

    .btn{
      width:100%; text-align:center; padding:13px 14px;
      border-radius:14px; border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,0.12), rgba(255,255,255,0.04));
      color:var(--text); font-size:16px; cursor:pointer;
      transition: transform var(--speed), box-shadow var(--speed), border-color var(--speed), background var(--speed);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      user-select:none;
    }
    .btn:hover{ transform:translateY(-1px); border-color:rgba(255,255,255,0.35); background:linear-gradient(180deg, rgba(255,255,255,0.18), rgba(255,255,255,0.06)); box-shadow:0 6px 16px rgba(0,0,0,0.2)}
    .btn:active{ transform:translateY(0) }
    .btn.primary{ background:linear-gradient(145deg, var(--primary), var(--primary-800)); color:#fff; border-color:transparent; box-shadow:0 8px 18px rgba(76,181,255,0.35)}
    .btn.primary:hover{ box-shadow:0 12px 24px rgba(76,181,255,0.45) }

    .input-wrap{display:grid; gap:8px}
    .input-wrap label{font-weight:700}
    .input, .textarea{
      padding:12px 14px; border-radius:12px; border:1px solid var(--border);
      background:rgba(255,255,255,0.06); color:var(--text);
    }
    .textarea{ min-height:88px; resize:vertical }

    /* כרטיס סיכום קצר */
    .summary{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
      padding:12px 14px; border-radius:14px;
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      border:1px solid var(--border); box-shadow:var(--shadow-md); margin:10px 0;
    }
    .chip{
      padding:6px 10px; border-radius:999px; border:1px solid var(--border);
      background:rgba(255,255,255,0.06); font-size:14px
    }

    @media (max-width:540px){
      .body{padding:16px}
      .footer{padding:12px 16px}
      .title{font-size:16px}
      .logo{width:38px;height:38px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="head">
        <div class="brand">
          <div class="logo">HB</div>
          <div class="title">יוסטון – שיעור על בסיס מקום פנוי</div>
        </div>
        <div></div>
      </div>

      <div class="body"><div id="area"></div></div>

      <div class="footer">
        <button id="backBtn" class="btn" type="button">חזרה</button>
        <button id="homeBtn" class="btn primary" type="button">לתפריט ראשי</button>
      </div>
    </div>
  </div>

  <script>
    /* ======== Web App URL (Apps Script) ======== */
    const SHEETS_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbwnNKY0BeO5N2O9oWmr8ltCHr9fVdDdrXsL_3erastx4qdEqhCz1mYAhkvZETF-86CGnw/exec';

    /* ======== Hebrew labels ======== */
    const HE = {
      path_on_demand: 'שיעור על בסיס מקום פנוי',
      cta_on_demand: 'שיעור חד־פעמי',
      source: 'יוסטון – אתר',
      status_new: 'חדש',
      plan: { group: 'קבוצה', triple: 'טריפל', private: 'פרטי' }
    };
    const PRICES = { group: 80, triple: 100, private: 160 };

    /* ======== DOM ======== */
    const area    = document.getElementById('area');
    const backBtn = document.getElementById('backBtn');
    const homeBtn = document.getElementById('homeBtn');
    const clear   = () => area.innerHTML = '';

    /* ======== State ======== */
    const state = {
      history: [],
      data: {
        path: null,
        subject: null,      // עברית
        planType: null,     // 'group' | 'triple' | 'private'
        price: null,        // מספר
        availability: null, // טקסט חופשי
        message: null,      // אופציונלי
        fullName: null,
        phone: null,
        cta: null
      }
    };
    const push  = (fn)=> state.history.push(fn);
    const goBack= ()=>{ if(state.history.length>1){ state.history.pop(); state.history.at(-1)(); } };
    const goHome= ()=>{ state.history.length=0; state.data={ path:null,subject:null,planType:null,price:null,availability:null,message:null,fullName:null,phone:null,cta:null }; step1(); };
    backBtn.onclick = goBack;
    homeBtn.onclick = goHome;

    /* ======== UI helpers ======== */
    const p   = html => { const b=document.createElement('div'); b.className='bubble'; b.innerHTML=html; area.appendChild(b); return b; };
    const btn = (text, onClick, cls='btn') => { const b=document.createElement('button'); b.className=cls; b.textContent=text; b.onclick=onClick; area.appendChild(b); return b; };

    function inputRow(label, type='text', id, {dir='rtl', textarea=false, placeholder=''}={}){
      const wrap=document.createElement('div'); wrap.className='input-wrap bubble';
      const l=document.createElement('label'); l.textContent=label;
      let i;
      if (textarea){ i=document.createElement('textarea'); i.className='textarea'; }
      else { i=document.createElement('input'); i.type=type; i.className='input'; i.autocomplete=(id==='phone'?'tel':'name'); }
      i.id=id; i.dir=dir; if(placeholder) i.placeholder=placeholder;
      wrap.appendChild(l); wrap.appendChild(i); area.appendChild(wrap);
      return i;
    }

    function summaryCard(){
      const s=document.createElement('div'); s.className='summary';
      const ch1=document.createElement('div'); ch1.className='chip'; ch1.textContent=`מסלול: ${HE.plan[state.data.planType]} (${state.data.price}₪)`;
      const ch2=document.createElement('div'); ch2.className='chip'; ch2.textContent=`מקצוע: ${state.data.subject}`;
      s.appendChild(ch1); s.appendChild(ch2);
      area.appendChild(s);
    }

    // טלפון ישראלי
    const normalizeILPhone = raw => {
      let p=(raw||'').toString().trim().replace(/[^\d+]/g,'');
      if(p.startsWith('+972')) p='0'+p.slice(4);
      if(p.startsWith('972'))  p='0'+p.slice(3);
      return p;
    };
    const validILPhone = p => /^0\d{8,9}$/.test(p||'');

    // שליחה ל–Sheets
    async function sendLeadToSheet(payload){
      try{
        const res = await fetch(SHEETS_WEBAPP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify(payload)
        });
        const j = await res.json().catch(()=>({ok:false}));
        return j.ok === true || res.ok;
      }catch(e){
        console.error('Sheets webapp error', e);
        return false;
      }
    }

    /* ========== FLOW (ענף 1 מקוצר) ========== */

    function step1(){
      clear(); push(step1);
      p('<strong>היי, אני יוסטון 👨‍🚀</strong><br>העוזר הדיגיטלי של מרכז בראונשטיין.');
      p('<strong>איך אוכל לעזור?</strong><br><span class="muted">בחרי אפשרות אחת מהכפתורים למטה.</span>');
      btn('ברשותי מנוי חודשי קבוע', ()=>alert('כרגע מתמקדים בשיעור חד־פעמי'));
      btn('פרטים על מנוי חודשי',     ()=>alert('כרגע מתמקדים בשיעור חד־פעמי'));
      btn('שיעור על בסיס מקום פנוי', ()=>{ state.data.path = HE.path_on_demand; stepPlan(); });
    }

    // שלב 2 – בחירת מסלול
    function stepPlan(){
      clear(); push(stepPlan);
      p('<strong>שיעור על בסיס מקום פנוי</strong><br><span class="muted">בחרי מסלול חד־פעמי.</span>');
      btn('קבוצה – עד 5 תלמידים – 80₪',  ()=>{ state.data.planType='group';  state.data.price=PRICES.group;  stepSubject(); });
      btn('טריפל – עד 3 תלמידים – 100₪', ()=>{ state.data.planType='triple'; state.data.price=PRICES.triple; stepSubject(); });
      btn('פרטי – 160₪',                   ()=>{ state.data.planType='private';state.data.price=PRICES.private;stepSubject(); });
      btn('חזרה', goBack);
    }

    // שלב 3 – בחירת מקצוע
    function stepSubject(){
      clear(); push(stepSubject);
      p('<strong>איזה מקצוע לשיעור החד־פעמי?</strong>');
      ['אנגלית','מתמטיקה','פיזיקה','שפה','אנגלית מדוברת'].forEach(l=>{
        btn(l, ()=>{ state.data.subject=l; stepDetailsOnePage(); });
      });
      btn('חזרה', goBack);
    }

    // שלב 4 – דף מאוחד: זמינות + הודעה + שם + טלפון + שליחה
    function stepDetailsOnePage(){
      clear(); push(stepDetailsOnePage);
      p('<strong>פרטי שיבוץ</strong><br><span class="muted">מלאי את הפרטים ונשלח למזכירות.</span>');
      summaryCard(); // סיכום אחד קצר בלבד

      const avail = inputRow('ימי ושעות זמינות','text','availability',{dir:'rtl', textarea:true, placeholder:'לדוגמה: א׳–ג׳ 15:00–19:00; ו׳ בוקר'});
      const msg   = inputRow('הודעה חופשית (לא חובה)','text','message',{dir:'rtl', textarea:true, placeholder:'העדפה למורה / רמה / הערות מיוחדות'});
      const name  = inputRow('שם מלא','text','fullName',{dir:'rtl', placeholder:'לדוגמה: דנה לוי'});
      const phone = inputRow('טלפון לחזרה','tel','phone',{dir:'rtl', placeholder:'לדוגמה: 0501234567'});

      const send = btn('שליחה למזכירות', async ()=>{
        // ולידציה קצרה
        const fullName=(name.value||'').trim();
        const phoneNorm = normalizeILPhone(phone.value||'');
        const availability=(avail.value||'').trim();
        if(!availability){ p('אנא כתבי זמינות (ימים ושעות).').classList.add('err'); return; }
        if(!fullName){ p('יש להזין שם מלא.').classList.add('err'); return; }
        if(!validILPhone(phoneNorm)){ p('מספר טלפון לא תקין (למשל 0501234567).').classList.add('err'); return; }

        // שמירה ב-state
        state.data.availability = availability;
        state.data.message = (msg.value||'').trim();
        state.data.fullName = fullName;
        state.data.phone = phoneNorm;

        // שליחה
        send.disabled = true; send.textContent = 'שולח...';
        const payload = {
          path: HE.path_on_demand,
          planType: HE.plan[state.data.planType],
          price: `${state.data.price}₪`,
          subject: state.data.subject,
          availability: state.data.availability,
          message: state.data.message || '',
          fullName: state.data.fullName,
          phone: state.data.phone,
          cta: HE.cta_on_demand,
          source: HE.source,
          status: HE.status_new,
          createdAt: new Date().toISOString()
        };
        const ok = await sendLeadToSheet(payload);
        if(ok) return stepSuccess();
        send.disabled = false; send.textContent = 'שליחה למזכירות';
        p('לא הצלחנו לשמור את הבקשה לגיליון. אפשר לנסות שוב או לפנות אלינו בוואטסאפ 050‑9570866.').classList.add('err');
      }, 'btn primary');

      btn('חזרה', goBack);
    }

    // הצלחה
    function stepSuccess(){
      clear(); push(stepSuccess);
      p('הבקשה נרשמה והועברה למזכירות 🛰️ נחזור אלייך בקרוב כדי לבדוק זמינות ולהשריין שיעור.').classList.add('ok');
      btn('לתפריט ראשי', goHome, 'btn primary');
      btn('פתח/י את הגיליון', ()=> window.open('https://docs.google.com/spreadsheets/d/1vQGA0aeXj9yncK2ZbuYZjrvQgPdpp7qN5FCxWBSAUd4/edit#gid=0','_blank','noopener'));
    }

    // Start
    step1();
  </script>
</body>
</html>