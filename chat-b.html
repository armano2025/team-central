<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>צ'ט משופר – Firestore</title>
  <meta name="theme-color" content="#3498db" />
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css" />
  <script src="https://unpkg.com/feather-icons"></script>
  <style>
    :root{--radius:16px;--card:#fff;--border:#e5e7eb;--muted:#6b7280;--primary:#3498db;--bg:#f7f7f9}
    body{background:var(--bg);font-family:'Rubik',system-ui}
    .wrap{max-width:760px;margin:24px auto;padding:0 12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:0 8px 20px rgba(0,0,0,.06);overflow:hidden}
    .head{display:flex;align-items:center;justify-content:space-between;background:var(--primary);color:#fff;padding:14px 16px}
    .head .title{font-weight:700}
    .head a{color:#fff;text-decoration:none;display:inline-flex;gap:6px;align-items:center}
    .body{padding:16px;min-height:260px}
    .btn{display:block;width:100%;text-align:center;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:#fff;cursor:pointer;font-size:16px;margin:8px 0}
    .btn:hover{background:#fafafa}
    .btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
    .bubble{background:#f1f5f9;border:1px solid var(--border);padding:12px 14px;border-radius:12px;margin:8px 0;line-height:1.7}
    .links a{display:inline-block;margin:4px 0;color:var(--primary);text-decoration:none;border-bottom:1px dashed var(--primary)}
    .skeleton{height:44px;border-radius:12px;margin:8px 0;background:linear-gradient(90deg,#eee 25%,#f5f5f5 37%,#eee 63%);background-size:400% 100%;animation:shimmer 1.4s ease infinite}
    @keyframes shimmer{0%{background-position:100% 0}100%{background-position:-100% 0}}
    .footer{display:flex;gap:8px;border-top:1px solid var(--border);padding:12px 16px}
    .error{background:#fff1f2;border-color:#fca5a5;color:#7f1d1d}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="head">
        <div class="title">צ'ט משופר (Firestore)</div>
        <a href="admin.html"><i data-feather="arrow-right"></i> חזרה ל־Admin</a>
      </div>
      <div class="body"><div id="area"></div></div>
      <div class="footer">
        <button id="backBtn" class="btn">חזרה</button>
        <button id="homeBtn" class="btn">לתפריט ראשי</button>
      </div>
    </div>
  </div>

  <script type="module">
    feather.replace();

    // קונפיג Firebase שלך
    const firebaseConfig = {
      apiKey: "AIzaSyDIof9bpkgL1L7mlbmj-JXQ3GHDTnTQpSM",
      authDomain: "brawnshtein-team.firebaseapp.com",
      projectId: "brawnshtein-team",
      storageBucket: "brawnshtein-team.firebasestorage.app",
      messagingSenderId: "44992266530",
      appId: "1:44992266530:web:d27bd36cba15c464cb257b",
      measurementId: "G-D6TEBLLXTP"
    };

    // ייבוא מודולים מה-CDN
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import {
      getFirestore, collection, getDocs, query, where, orderBy, limit
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    // אתחול
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // DOM helpers
    const area    = document.getElementById('area');
    const backBtn = document.getElementById('backBtn');
    const homeBtn = document.getElementById('homeBtn');
    const nav     = [];
    const clear   = () => area.innerHTML = '';
    const skeleton= (n=5)=>{ clear(); for(let i=0;i<n;i++){ const d=document.createElement('div'); d.className='skeleton'; area.appendChild(d);} };

    backBtn.onclick = ()=>{ if(nav.length>1){ nav.pop(); render(nav.at(-1)); } };
    homeBtn.onclick = ()=>{ nav.length=0; loadCategories(); };

    // שלב א: קטגוריות
    async function loadCategories(){
      skeleton(6);
      const snap = await getDocs(query(collection(db,'faq'), where('active','==', true)));
      const map = new Map();
      snap.forEach(doc=>{
        const d=doc.data();
        const key = d.category_slug || d.category_name;
        if(!key) return;
        if(!map.has(key)) map.set(key, {category_slug:d.category_slug, category_name:d.category_name, count:0});
        map.get(key).count++;
      });
      const cats = Array.from(map.values()).sort((a,b)=> a.category_name.localeCompare(b.category_name,'he'));
      nav.push({view:'cats', items:cats});
      render(nav.at(-1));
    }

    // שלב ב: שאלות בקטגוריה
    async function loadQuestions(slug, name){
      skeleton(6);
      const q = query(collection(db,'faq'),
        where('active','==', true),
        where('category_slug','==', slug)
      );
      const snap = await getDocs(q);
      const items = [];
      snap.forEach(doc=>{
        const d=doc.data();
        items.push({slug:d.question_slug, text:d.question_text});
      });
      nav.push({view:'qs', items, meta:{slug, name}});
      render(nav.at(-1));
    }

    // שלב ג: תשובה
    async function loadAnswer(slug){
      skeleton(2);
      const q = query(collection(db,'faq'),
        where('active','==', true),
        where('question_slug','==', slug),
        limit(1)
      );
      const snap = await getDocs(q);
      if (snap.empty){
        clear();
        const e=document.createElement('div'); e.className='bubble error';
        e.textContent='לא נמצאה תשובה לשאלה זו.';
        area.appendChild(e); return;
      }
      const d = snap.docs[0].data();
      nav.push({view:'ans', data:d});
      render(nav.at(-1));
    }

    // רינדור
    function render(state){
      clear();
      if(state.view==='cats'){
        state.items.forEach(c=>{
          const b=document.createElement('button');
          b.className='btn';
          b.textContent=`${c.category_name} (${c.count})`;
          b.onclick=()=>loadQuestions(c.category_slug, c.category_name);
          area.appendChild(b);
        });
      }
      if(state.view==='qs'){
        state.items.forEach(q=>{
          const b=document.createElement('button');
          b.className='btn';
          b.textContent=q.text;
          b.onclick=()=>loadAnswer(q.slug);
          area.appendChild(b);
        });
      }
      if(state.view==='ans'){
        const d = state.data;
        const head=document.createElement('div');
        head.className='bubble';
        head.innerHTML = `<strong>${d.question_text || ''}</strong><br>${d.answer_short || ''}`;
        area.appendChild(head);

        const more=document.createElement('button');
        more.className='btn primary';
        more.textContent='פרטים נוספים';
        more.onclick=()=>{
          const box=document.createElement('div');
          box.className='bubble';
          box.innerHTML = d.answer_full || d.answer_short || '';
          if (Array.isArray(d.links) && d.links.length){
            const list=document.createElement('div'); list.className='links';
            d.links.forEach(h=>{ const a=document.createElement('a'); a.href=h; a.target="_blank"; a.rel="noopener"; a.textContent=h; list.appendChild(a); });
            box.appendChild(list);
          }
          area.appendChild(box);
        };
        area.appendChild(more);
      }
    }

    // התחלה
    loadCategories();
  </script>
</body>
</html>