<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>צ'ט יוסטון – Leads לשיטס</title>

  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet" />
  <meta name="theme-color" content="#0f172a" />

  <style>
    /* ---------- Design Tokens ---------- */
    :root{
      --bg:#0b1220; --bg-grad-1:#0b1220; --bg-grad-2:#101a33;
      --glass:rgba(255,255,255,0.06); --glass-strong:rgba(255,255,255,0.12);
      --border:rgba(255,255,255,0.16); --text:#e5edf8; --muted:#9fb1c8;
      --primary:#4cb5ff; --primary-800:#1c78b2; --success:#10b981; --danger:#ef4444;
      --radius-xl:22px; --shadow-xl:0 20px 60px rgba(0,0,0,.35);
      --shadow-md:0 10px 30px rgba(0,0,0,.25); --blur:14px; --speed:.22s;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f3f6fb; --bg-grad-1:#eff4fb; --bg-grad-2:#e9f1fb;
        --glass:rgba(255,255,255,0.75); --glass-strong:rgba(255,255,255,0.9);
        --border:rgba(15,23,42,0.12); --text:#0f172a; --muted:#475569;
        --primary:#2563eb; --primary-800:#1e40af; --success:#059669; --danger:#dc2626;
      }
    }

    /* ---------- Base ---------- */
    html,body{height:100%}
    body{
      margin:0; font-family:'Rubik',system-ui,-apple-system,Segoe UI,Arial,Helvetica;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 90% -10%, #153057 0%, transparent 60%),
        radial-gradient(1200px 800px at -10% 100%, #0a6bd9 0%, transparent 55%),
        linear-gradient(160deg, var(--bg-grad-1), var(--bg-grad-2));
      background-attachment: fixed;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    *{box-sizing:border-box}

    /* ---------- Layout ---------- */
    .wrap{max-width:880px;margin:28px auto;padding:0 16px}
    .card{
      position:relative; border-radius:var(--radius-xl);
      background:var(--glass); border:1px solid var(--border);
      box-shadow:var(--shadow-xl); backdrop-filter: blur(var(--blur));
      overflow:hidden;
    }
    .head{
      padding:20px 22px; display:flex; align-items:center; justify-content:space-between;
      background:
        linear-gradient(135deg, rgba(255,255,255,.08), rgba(255,255,255,0) 40%),
        linear-gradient(135deg, rgba(76,181,255,.22), rgba(76,181,255,0) 55%);
      border-bottom:1px solid var(--border);
    }
    .brand{display:flex; align-items:center; gap:12px}
    .logo{
      width:42px;height:42px;border-radius:50%;display:grid;place-items:center;
      background:linear-gradient(145deg, var(--primary), var(--primary-800));
      color:#fff;font-weight:700;letter-spacing:.5px;
      box-shadow:inset 0 0 10px rgba(255,255,255,.25), 0 10px 24px rgba(76,181,255,.35);
    }
    .title{font-weight:700;font-size:18px}

    .body{
      padding:22px; min-height:360px; display:grid; align-items:start;
      background:
        radial-gradient(800px 300px at 50% -30%, rgba(255,255,255,.08), transparent 60%),
        radial-gradient(700px 260px at 10% 120%, rgba(76,181,255,.10), transparent 60%);
    }
    #area{ max-width:680px; margin:0 auto; width:100% }

    .footer{
      display:flex; gap:10px; padding:14px 22px; border-top:1px solid var(--border);
      background:linear-gradient(0deg, rgba(255,255,255,.06), rgba(255,255,255,0));
    }

    /* ---------- Components ---------- */
    .bubble{
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      border:1px solid var(--border);
      padding:14px 16px; border-radius:16px; margin:10px 0;
      line-height:1.8; box-shadow:var(--shadow-md);
    }
    .bubble strong{font-weight:700}
    .muted{color:var(--muted)}
    .ok{background:linear-gradient(180deg, rgba(16,185,129,.18), rgba(16,185,129,.10)); border-color:rgba(16,185,129,.45)}
    .err{background:linear-gradient(180deg, rgba(239,68,68,.20), rgba(239,68,68,.10)); border-color:rgba(239,68,68,.45)}

    .btn{
      width:100%; text-align:center; padding:13px 14px;
      border-radius:14px; border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,0.12), rgba(255,255,255,0.04));
      color:var(--text); font-size:16px; cursor:pointer;
      transition: transform var(--speed), box-shadow var(--speed), border-color var(--speed), background var(--speed);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      will-change: transform; user-select:none;
    }
    .btn:hover{
      transform: translateY(-1px);
      border-color: rgba(255,255,255,0.35);
      background:linear-gradient(180deg, rgba(255,255,255,0.18), rgba(255,255,255,0.06));
      box-shadow: 0 6px 16px rgba(0,0,0,0.2);
    }
    .btn:active{ transform: translateY(0) }
    .btn.primary{
      background:linear-gradient(145deg, var(--primary), var(--primary-800));
      color:#fff; border-color:transparent;
      box-shadow:0 8px 18px rgba(76,181,255,0.35);
    }
    .btn.primary:hover{ box-shadow:0 12px 24px rgba(76,181,255,0.45) }

    /* Inputs */
    .input-wrap{display:grid; gap:8px}
    .input-wrap label{font-weight:700}
    .input{
      padding:12px 14px; border-radius:12px; border:1px solid var(--border);
      background:rgba(255,255,255,0.06); color:var(--text);
    }

    /* מובייל */
    @media (max-width:540px){
      .body{padding:16px}
      .footer{padding:12px 16px}
      .title{font-size:16px}
      .logo{width:38px;height:38px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="head">
        <div class="brand">
          <div class="logo">HB</div>
          <div class="title">צ'ט יוסטון – Leads לשיטס</div>
        </div>
        <div></div>
      </div>

      <div class="body"><div id="area"></div></div>

      <div class="footer">
        <button id="backBtn" class="btn" type="button">חזרה</button>
        <button id="homeBtn" class="btn primary" type="button">לתפריט ראשי</button>
      </div>
    </div>
  </div>

  <script>
    /* ======== Config: Google Sheets Web App ======== */
    const SHEETS_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbwnNKY0BeO5N2O9oWmr8ltCHr9fVdDdrXsL_3erastx4qdEqhCz1mYAhkvZETF-86CGnw/exec';

    /* ======== DOM ======== */
    const area    = document.getElementById('area');
    const backBtn = document.getElementById('backBtn');
    const homeBtn = document.getElementById('homeBtn');
    const clear   = () => area.innerHTML = '';

    /* ======== State ======== */
    const state = {
      history: [],
      data: { path:null, subject:null, planType:null, price:null, cta:null, fullName:null, phone:null }
    };
    const push  = (fn)=> state.history.push(fn);
    const goBack= ()=>{ if(state.history.length>1){ state.history.pop(); state.history.at(-1)(); } };
    const goHome= ()=>{ state.history.length=0; state.data={path:null,subject:null,planType:null,price:null,cta:null,fullName:null,phone:null}; step1(); };
    backBtn.onclick = goBack;
    homeBtn.onclick = goHome;

    /* ======== UI helpers ======== */
    function p(html){ const b=document.createElement('div'); b.className='bubble'; b.innerHTML=html; area.appendChild(b); return b; }
    function btn(text, onClick, cls='btn'){ const b=document.createElement('button'); b.className=cls; b.textContent=text; b.onclick=onClick; area.appendChild(b); return b; }

    // inputs
    function inputRow(label, type='text', id){
      const wrap=document.createElement('div'); wrap.className='bubble input-wrap';
      const l=document.createElement('label'); l.textContent=label;
      const i=document.createElement('input'); i.type=type; i.id=id; i.dir='ltr'; i.className='input';
      i.autocomplete=(id==='phone'?'tel':'name');
      wrap.appendChild(l); wrap.appendChild(i); area.appendChild(wrap);
      return i;
    }

    // phone helpers (IL)
    const normalizeILPhone = raw => {
      let p=(raw||'').toString().trim().replace(/[^\d+]/g,'');
      if(p.startsWith('+972')) p='0'+p.slice(4);
      if(p.startsWith('972'))  p='0'+p.slice(3);
      return p;
    };
    const validILPhone = p => /^0\d{8,9}$/.test(p||'');

    /* ======== Sheets sender ======== */
    async function sendLeadToSheet(payload){
      try{
        const res = await fetch(SHEETS_WEBAPP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' }, // מפחית Preflight
          body: JSON.stringify(payload)
        });
        const j = await res.json().catch(()=>({ok:false}));
        return j.ok === true || res.ok;
      }catch(e){
        console.error('Sheets webapp error', e);
        return false;
      }
    }

    /* ========== FLOW ========== */

    // STEP 1 – פתיח
    function step1(){
      clear(); push(step1);
      p('<strong>היי, אני יוסטון 👨‍🚀</strong><br>העוזר הדיגיטלי של מרכז בראונשטיין.<br><br>אני כאן כדי לעזור לך עד כמה שאוכל.');
      p('<strong>איך אוכל לעזור?</strong><br><span class="muted">בחרי אפשרות אחת מהכפתורים למטה.</span>');

      btn('ברשותי מנוי חודשי קבוע', ()=>{ state.data.path='have_subscription'; stepHaveSubscription(); });
      btn('פרטים על מנוי חודשי',     ()=>{ state.data.path='subscription_info'; stepChooseSubject(); });
      btn('שיעור על בסיס מקום פנוי', ()=>{ state.data.path='on_demand'; stepOnDemandChoosePlan(); });
    }

    // מנויה קיימת (פנייה נשמרת לשיטס)
    function stepHaveSubscription(){
      clear(); push(stepHaveSubscription);
      p('<strong>ברוכה השבה</strong><br><span class="muted">בחרי מה תרצי לעשות.</span>');
      btn('שינוי מועד שיעור',    ()=> stepCollectContact(({fullName,phone})=> finalizeLead({path:'have_subscription', reason:'change_schedule', fullName, phone})));
      btn('בירור תשלום/חשבונית', ()=> stepCollectContact(({fullName,phone})=> finalizeLead({path:'have_subscription', reason:'billing', fullName, phone})));
      btn('שליחת הודעה למורה',   ()=> stepCollectContact(({fullName,phone})=> finalizeLead({path:'have_subscription', reason:'message_to_teacher', fullName, phone})));
      btn('חזרה', goBack);
    }

    // בחירת מקצוע (לענף מידע על מנוי)
    function stepChooseSubject(){
      clear(); push(stepChooseSubject);
      p('<strong>באיזה מקצוע תרצי ללמוד?</strong><br><span class="muted">בחרי אפשרות אחת.</span>');
      ['אנגלית','מתמטיקה','פיזיקה','שפה','אנגלית מדוברת'].forEach(label=>{
        btn(label, ()=>{ state.data.subject=label; stepSubscriptionOrOnDemand(); });
      });
      btn('חזרה', goBack);
    }

    // לבחור: שיעור חד פעמי או מנוי
    function stepSubscriptionOrOnDemand(){
      clear(); push(stepSubscriptionOrOnDemand);
      p('<strong>על מה תרצי לשמוע פרטים?</strong><br><span class="muted">שיעור חד־פעמי או מנוי קבוע.</span>');
      btn('שיעור חד-פעמי על בסיס מקום פנוי', ()=>{ state.data.path='on_demand'; stepOnDemandChoosePlan(); });
      btn('מנוי קבוע – שיעור פעם בשבוע',       stepSubscriptionPlans);
      btn('חזרה', goBack);
    }

    // מסלולי מנוי
    function stepSubscriptionPlans(){
      clear(); push(stepSubscriptionPlans);
      p('<strong>מסלולי מנוי</strong><br><span class="muted">בחרי את המסלול המתאים.</span>');
      btn('מסלול קבוצה – עד 5 תלמידים – 295₪', ()=>{ state.data.planType='group';  state.data.price=295; stepCTA(); });
      btn('מסלול טריפל – עד 3 תלמידים – 385₪', ()=>{ state.data.planType='triple'; state.data.price=385; stepCTA(); });
      btn('מסלול פרטי – 685₪',                  ()=>{ state.data.planType='private';state.data.price=685; stepCTA(); });
      btn('חזרה', goBack);
    }

    // שיעור חד-פעמי: בחירת מסלול
    function stepOnDemandChoosePlan(){
      clear(); push(stepOnDemandChoosePlan);
      p('<strong>שיעור על בסיס מקום פנוי</strong><br><span class="muted">בחרי מסלול חד־פעמי.</span>');
      btn('קבוצה – עד 5 תלמידים – 70₪',  ()=>{ state.data.planType='group';  state.data.price=70;  stepOnDemandSubject(); });
      btn('טריפל – עד 3 תלמידים – 100₪', ()=>{ state.data.planType='triple'; state.data.price=100; stepOnDemandSubject(); });
      btn('פרטי – 160₪',                   ()=>{ state.data.planType='private';state.data.price=160; stepOnDemandSubject(); });
      btn('חזרה', goBack);
    }

    // שיעור חד-פעמי: בחירת מקצוע
    function stepOnDemandSubject(){
      clear(); push(stepOnDemandSubject);
      p('<strong>איזה מקצוע לשיעור החד־פעמי?</strong><br><span class="muted">בחרי מקצוע אחד.</span>');
      ['אנגלית','מתמטיקה','פיזיקה','שפה','אנגלית מדוברת'].forEach(l=>{
        btn(l, ()=>{ state.data.subject=l; stepOnDemandSummary(); });
      });
      btn('חזרה', goBack);
    }

    // שיעור חד-פעמי: סיכום → פרטי קשר → שליחה לשיטס
    function stepOnDemandSummary(){
      clear(); push(stepOnDemandSummary);
      const {subject, planType, price} = state.data;
      const planHeb = planType==='group'?'קבוצה':planType==='triple'?'טריפל':'פרטי';
      p('<strong>סיכום</strong><br><span class="muted">בדקי שהכול נכון ואז המשיכי להזנת פרטי קשר.</span>');
      p(`שיעור חד־פעמי ב${subject} במסלול ${planHeb} – ${price}₪.`);
      btn('המשך להזנת פרטי קשר', ()=> stepCollectContact(({fullName,phone})=>{
        finalizeLead({
          path:'on_demand',
          subject, planType, price,
          cta:'lesson_this_week',
          fullName, phone
        });
      }), 'btn primary');
      btn('חזרה', goBack);
    }

    // איסוף שם + טלפון
    function stepCollectContact(next){
      clear(); push(()=>stepCollectContact(next));
      p('<strong>פרטי קשר</strong><br><span class="muted">מלאי שם מלא ומספר טלפון לחזרה.</span>');
      const nameInput  = inputRow('שם מלא','text','fullName');
      const phoneInput = inputRow('טלפון לחזרה','tel','phone');

      btn('המשך', ()=>{
        const fullName=(nameInput.value||'').trim();
        const phone   = normalizeILPhone(phoneInput.value||'');
        if(!fullName){ p('יש להזין שם מלא.').classList.add('err'); return; }
        if(!validILPhone(phone)){ p('מספר טלפון לא תקין (למשל 0501234567).').classList.add('err'); return; }
        state.data.fullName=fullName; state.data.phone=phone;
        next({fullName,phone});
      }, 'btn primary');
      btn('חזרה', goBack);
    }

    // CTA של מנוי: שיחזרו אליי / שיעור השבוע → פרטי קשר → שליחה לשיטס
    function stepCTA(){
      clear(); push(stepCTA);
      const {subject, planType, price} = state.data;
      const planHeb = planType==='group'?'קבוצה':planType==='triple'?'טריפל':'פרטי';
      p('<strong>מה תרצי לעשות עכשיו?</strong><br><span class="muted">בחרי פעולה, נבקש פרטי קשר ונשלח למזכירות.</span>');
      p(`${subject ? 'מקצוע: '+subject+' · ' : ''}מסלול: ${planHeb} · ${price}₪ לחודש`);

      btn('שיחזרו אליי עם פרטים נוספים', ()=>{
        stepCollectContact(({fullName,phone})=>{
          finalizeLead({
            path:'subscription_info',
            subject, planType, price,
            cta:'callback',
            fullName, phone
          });
        });
      });

      btn('אני רוצה שיעור כבר היום (או השבוע)', ()=>{
        stepCollectContact(({fullName,phone})=>{
          finalizeLead({
            path:'subscription_info',
            subject, planType, price,
            cta:'lesson_this_week',
            fullName, phone
          });
        });
      });

      btn('חזרה לתפריט הראשי', goHome);
      btn('חזרה', goBack);
    }

    // כתיבה סופית לשיטס + פידבק
    async function finalizeLead(payload){
      const toSend = {
        ...payload,
        source:'web-app',
        status:'new',
        createdAt: new Date().toISOString()
      };
      const okGS = await sendLeadToSheet(toSend);

      clear();
      if(okGS){
        p('הבקשה נרשמה והתווספה לגיליון. המזכירות יצורו איתך קשר בקרוב כדי לבדוק זמינות ולהשריין שיעור.').classList.add('ok');
      }else{
        p('לא הצלחנו לשמור את הבקשה לגיליון. אפשר לנסות שוב או לפנות אלינו בוואטסאפ 050-9570866.').classList.add('err');
      }
      btn('לתפריט ראשי', goHome, 'btn primary');
    }

    // Start
    step1();
  </script>
</body>
</html>