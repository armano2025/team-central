<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Flow</title>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css" />
  <script src="https://unpkg.com/feather-icons"></script>
  <style>
    .pill{display:inline-flex;align-items:center;gap:6px;background:rgba(0,0,0,.06);padding:6px 10px;border-radius:999px;font-size:.9rem}
    .hero .row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
    .hero .stat{flex:1 1 180px; text-align:center;background:rgba(255,255,255,.18);padding:12px;border-radius:999px}
    .search-wrap{display:flex;gap:8px;align-items:center;margin:12px 0}
    .search-wrap input{width:100%;padding:10px 14px;border-radius:12px;border:1px solid #ddd}
    .cols{display:grid;grid-template-columns:1fr;gap:16px}
    @media (min-width: 920px){ .cols{grid-template-columns:1fr 1fr} }
    .group-head{font-weight:700;margin:14px 6px}
    .card{align-items:stretch;text-align:right}
    .kv{display:grid;grid-template-columns:1fr 1fr; gap:10px}
    .kv .box{background:var(--color-bg);border-radius:12px;padding:12px}
    .muted{opacity:.65}
    .actions{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:14px;background:rgba(0,0,0,.85);color:#fff;padding:10px 14px;border-radius:12px}
    details summary{cursor:pointer; list-style:none}
    details summary::-webkit-details-marker{display:none}
  </style>
</head>
<body>
  <nav class="top-buttons" aria-label="ניווט עליון">
    <a href="javascript:void(0)" onclick="history.back()" title="חזור"><i data-feather="arrow-right"></i> חזור</a>
    <a href="admin.html" title="אדמין"><i data-feather="settings"></i> אדמין</a>
    <a id="sheetBtn" href="#" target="_blank" rel="noopener" title="לגליון"><i data-feather="book-open"></i> גליון</a>
    <button id="refresh-btn" type="button" title="ריענון"><i data-feather="rotate-cw"></i> ריענון</button>
    <button id="dark-toggle" type="button" title="מצב כהה/בהיר"><i data-feather="moon"></i></button>
  </nav>

  <header class="hero">
    <div class="hero-content">
      <h2 id="title">Flow</h2>
      <p class="muted">תצוגת עבודה – טור "לטיפול" וטור "בעבודה".</p>
      <div class="row">
        <div class="stat">בעבודה <strong id="cnt-work">0</strong></div>
        <div class="stat">לטיפול <strong id="cnt-in">0</strong></div>
      </div>
    </div>
  </header>

  <div class="search-wrap">
    <span class="pill muted" id="flowKeyPill">—</span>
    <input id="q" type="search" placeholder="חיפוש: שם, משפחה, טלפון, מקצוע, הערות…" />
  </div>

  <div class="cols">
    <section>
      <div class="group-head">לטיפול</div>
      <div id="list-in"></div>
    </section>
    <section>
      <div class="group-head">בעבודה</div>
      <div id="list-work"></div>
    </section>
  </div>

  <div id="toast" class="toast" style="display:none"></div>
  <p id="err" class="error" style="color:#b00020;margin-top:10px" hidden></p>

  <script>
    feather.replace();
    (function(){
      const root = document.documentElement;
      if (localStorage.getItem('dark-mode') === '1') root.classList.add('dark-mode');
      document.getElementById('dark-toggle').addEventListener('click', ()=>{
        const on = root.classList.toggle('dark-mode');
        on ? localStorage.setItem('dark-mode','1') : localStorage.removeItem('dark-mode');
      });
    })();

    // ====== Panel API URL (כבר מולא) ======
    const API_URL = "https://script.google.com/macros/s/AKfycbxagWMbWh-tmxa03Z_6Z7AQK1Hgp3G8AkcBPgvj6eYLQxBm5aNMrPB7FfEEzHp0BT0H/exec";

    const qs = new URLSearchParams(location.search);
    const flowKey = qs.get('flowKey') || '';
    document.getElementById('flowKeyPill').textContent = flowKey || '—';

    function toast(msg, ms=1800){ const t = document.getElementById('toast'); t.textContent = msg; t.style.display='block'; setTimeout(()=>t.style.display='none', ms); }

    async function api(path, {method='GET', body, tries=2, timeout=12000}={}){
      const ctrl = new AbortController(); const to = setTimeout(()=>ctrl.abort(), timeout);
      try{
        const res = await fetch(API_URL + path, { method, headers: body?{'Content-Type':'application/json'}:undefined, body: body?JSON.stringify(body):undefined, signal: ctrl.signal });
        if(!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json().catch(()=>{ throw new Error('Bad JSON'); });
        if(!data || data.ok === false) throw new Error(data && data.error || 'API error');
        return data;
      }catch(e){ if(tries>0) return api(path,{method,body,tries:tries-1,timeout}); throw e; }
      finally{ clearTimeout(to); }
    }

    // Owners/Statuses/Names
    let META = {owners: [], statuses: [], flows: []};
    async function loadMeta() {
      const m = await api("?action=meta");
      META = m;
      const flow = META.flows.find(f => f.flowKey === flowKey);
      if (flow) document.getElementById('title').textContent = flow.friendlyName;
    }

    async function loadSheetLink(){
      const r = await api(`?action=sheetLink&flowKey=${encodeURIComponent(flowKey)}`);
      const a = document.getElementById('sheetBtn'); a.href = r.url; a.target = "_blank";
    }

    function selectHtml(id, options, value){
      const opts = options.map(o => `<option${o===value?' selected':''}>${o}</option>`).join('');
      return `<select id="${id}" class="pill" style="background:#eef;border:0;cursor:pointer">${opts}</select>`;
    }

    async function updateField(rowId, updates){
      const body = { action:'updateRow', flowKey, rowId, updates, actor:'WebPanel' };
      await api("", {method:'POST', body});
      toast('נשמר ✔︎');
    }

    function renderItem(item){
      const f = item.fields;
      const owners = META.owners && META.owners.length ? META.owners : ['ריק','חן','בלה','תמרה','ליאור','נטע'];
      const statuses = META.statuses && META.statuses.length ? META.statuses : ['לטיפול','בעבודה','הסתיים'];

      const ownerId = `owner_${item.rowId}`;
      const statusId = `status_${item.rowId}`;
      const notesId  = `notes_${item.rowId}`;

      return `
        <article class="card" id="row_${item.rowId}">
          <div class="actions" style="justify-content:space-between;margin-bottom:6px">
            <span class="pill muted">נוצר: ${f.createdAt || ''}</span>
            <span class="pill muted">מס׳ תיק: ${f.caseId || ''}</span>
          </div>

          <div class="actions" style="margin-bottom:8px">
            <span class="pill">מטפל: ${selectHtml(ownerId, owners, f.owner || 'ריק')}</span>
            <span class="pill">סטטוס: ${selectHtml(statusId, statuses, f.status || 'לטיפול')}</span>
          </div>

          <div class="kv">
            <div class="box"><div class="muted">שם</div><div>${(f.firstName||'') + ' ' + (f.lastName||'')}</div></div>
            <div class="box"><div class="muted">טלפון</div><div dir="ltr">${f.phone||''}</div></div>
            <div class="box"><div class="muted">תפקיד</div><div>${f.role||''}</div></div>
            <div class="box"><div class="muted">מקצוע</div><div>${f.subject||''}</div></div>
          </div>

          <div style="margin-top:10px">
            <div class="muted" style="margin-bottom:6px">הערת מנהל</div>
            <textarea id="${notesId}" rows="2" placeholder="כתוב הערה…" style="width:100%;padding:12px;border-radius:12px;border:1px solid #ddd">${f.adminNotes||''}</textarea>
          </div>

          <details style="margin-top:10px">
            <summary class="pill">פרטים נוספים ▾</summary>
            <div style="margin-top:10px">
              ${
                (f._keys||[]).map(k=>{
                  if (k==='adminNotes') return '';
                  const v = f[k];
                  return `<div class="box" style="margin:6px 0"><div class="muted">${k}</div><div>${v==null?'':v}</div></div>`;
                }).join('')
              }
            </div>
          </details>

          <div class="actions" style="justify-content:flex-end;margin-top:10px">
            <button class="pill" onclick="window.open(document.getElementById('sheetBtn').href,'_blank')"><i data-feather="book-open"></i>לשורה בגליון</button>
          </div>
        </article>

        <script>
          (function(){
            const ownerSel = document.getElementById('${ownerId}');
            ownerSel && ownerSel.addEventListener('change', async (e)=>{
              try { await updateField(${item.rowId}, {owner: e.target.value}); } catch(err){ alert('שגיאה בשמירה: '+err.message); }
            });
            const statusSel = document.getElementById('${statusId}');
            statusSel && statusSel.addEventListener('change', async (e)=>{
              try { await updateField(${item.rowId}, {status: e.target.value}); } catch(err){ alert('שגיאה בשמירה: '+err.message); }
            });
            const notes = document.getElementById('${notesId}');
            let h;
            notes && notes.addEventListener('input', ()=>{
              clearTimeout(h);
              h = setTimeout(async ()=>{
                try { await updateField(${item.rowId}, {adminNotes: notes.value}); }
                catch(err){ alert('שגיאה בשמירה: '+err.message); }
              }, 500);
            });
          })();
        </script>
      `;
    }

    async function loadColumn(which, q=''){
      const list = document.getElementById('list-'+which);
      list.innerHTML = '<div class="card" style="opacity:.6">טוען…</div>';
      const data = await api(`?action=flow&flowKey=${encodeURIComponent(flowKey)}&status=${which}${q?'&q='+encodeURIComponent(q):''}`);
      list.innerHTML = (data.items||[]).map(renderItem).join('') || '<div class="card" style="opacity:.6">אין משימות להצגה</div>';
      return data.meta ? data.meta.total : 0;
    }

    async function loadAll(){
      const err = document.getElementById('err'); err.hidden=true; err.textContent='';
      try{
        if(!flowKey){ err.hidden=false; err.textContent='חסר flowKey ב־URL'; return; }
        await loadMeta();
        await loadSheetLink();
        const q = document.getElementById('q').value.trim();
        const [inCnt, workCnt] = await Promise.all([ loadColumn('in', q), loadColumn('work', q) ]);
        document.getElementById('cnt-in').textContent = inCnt;
        document.getElementById('cnt-work').textContent = workCnt;
      }catch(e){ err.hidden=false; err.textContent='שגיאה בטעינה – '+e.message; }
    }

    document.getElementById('refresh-btn').addEventListener('click', loadAll);
    document.getElementById('q').addEventListener('input', ()=>{ clearTimeout(window.__q); window.__q=setTimeout(loadAll, 250); });

    loadAll();
  </script>
</body>
</html>