<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Flow</title>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css" />
  <script src="https://unpkg.com/feather-icons"></script>
  <style>
    .pill{display:inline-flex;align-items:center;gap:6px;background:rgba(0,0,0,.06);padding:6px 10px;border-radius:999px;font-size:.9rem}
    .hero .row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
    .hero .stat{flex:1 1 180px;text-align:center;background:rgba(255,255,255,.18);padding:12px;border-radius:999px}
    .search-wrap{display:flex;gap:8px;align-items:center;margin:12px 0}
    .search-wrap input{width:100%;padding:10px 14px;border-radius:12px;border:1px solid #ddd}
    .cols{display:grid;grid-template-columns:1fr;gap:16px}
    @media (min-width: 920px){ .cols{grid-template-columns:1fr 1fr} }
    .group-head{font-weight:700;margin:14px 6px}
    .card{align-items:stretch;text-align:right}
    .kv{display:grid;grid-template-columns:1fr 1fr; gap:10px}
    .kv .box{background:var(--color-bg);border-radius:12px;padding:12px}
    .muted{opacity:.65}
    .actions{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:14px;background:rgba(0,0,0,.85);color:#fff;padding:10px 14px;border-radius:12px}
    .error{color:#b00020;margin-top:10px}
    details summary{cursor:pointer;list-style:none}
    details summary::-webkit-details-marker{display:none}
  </style>
</head>
<body>
  <nav class="top-buttons">
    <a href="javascript:void(0)" onclick="history.back()"><i data-feather="arrow-right"></i> חזור</a>
    <a href="admin.html"><i data-feather="settings"></i> אדמין</a>
    <a id="sheetBtn" href="#" target="_blank" rel="noopener"><i data-feather="book-open"></i> גליון</a>
    <button id="refresh-btn" type="button" title="ריענון"><i data-feather="rotate-cw"></i> ריענון</button>
    <button id="dark-toggle" type="button" title="מצב כהה/בהיר"><i data-feather="moon"></i></button>
  </nav>

  <header class="hero">
    <div class="hero-content">
      <h2 id="title">Flow</h2>
      <p class="muted">תצוגת עבודה – טור "לטיפול" וטור "בעבודה".</p>
      <div class="row">
        <div class="stat">בעבודה <strong id="cnt-work">0</strong></div>
        <div class="stat">לטיפול <strong id="cnt-in">0</strong></div>
      </div>
    </div>
  </header>

  <div class="search-wrap">
    <span class="pill muted" id="flowKeyPill">—</span>
    <input id="q" type="search" placeholder="חיפוש: שם, משפחה, טלפון, מקצוע, הערות…" />
  </div>

  <div class="cols">
    <section>
      <div class="group-head">לטיפול</div>
      <div id="list-in"></div>
    </section>
    <section>
      <div class="group-head">בעבודה</div>
      <div id="list-work"></div>
    </section>
  </div>

  <div id="toast" class="toast" style="display:none"></div>
  <p id="err" class="error" hidden></p>

  <script>
    feather.replace();

    // Dark mode toggle
    (function(){
      const root=document.documentElement;
      if(localStorage.getItem('dark-mode')==='1') root.classList.add('dark-mode');
      document.getElementById('dark-toggle').addEventListener('click',()=>{
        const on=root.classList.toggle('dark-mode');
        on?localStorage.setItem('dark-mode','1'):localStorage.removeItem('dark-mode');
      });
    })();

    const API_URL="https://script.google.com/macros/s/AKfycbxagWMbWh-tmxa03Z_6Z7AQK1Hgp3G8AkcBPgvj6eYLQxBm5aNMrPB7FfEEzHp0BT0H/exec";

    async function api(path,{method='GET',body,timeout=12000}={}){
      const ctrl=new AbortController(); const to=setTimeout(()=>ctrl.abort(),timeout);
      try{
        const res=await fetch(API_URL+path,{method,headers:body?{'Content-Type':'application/json'}:undefined,body:body?JSON.stringify(body):undefined,signal:ctrl.signal});
        const txt=await res.text(); // תמיד קוראים טקסט, אח"כ נפרסר
        if(!res.ok) throw new Error('HTTP '+res.status+' '+txt);
        let data; try{ data=JSON.parse(txt);}catch(_){ throw new Error('Bad JSON: '+txt); }
        if(!data || data.ok===false) throw new Error(data && data.error || 'API error');
        return data;
      }finally{ clearTimeout(to); }
    }

    const qs=new URLSearchParams(location.search);
    const flowKey=qs.get('flowKey')||'';
    document.getElementById('flowKeyPill').textContent=flowKey||'—';

    function toast(msg,ms=1500){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',ms); }

    let META={owners:[],statuses:[],flows:[]};
    async function loadMeta(){
      const m=await api("?action=meta"); META=m;
      const flow=META.flows.find(f=>f.flowKey===flowKey);
      if(flow) document.getElementById('title').textContent=flow.friendlyName;
    }

    async function loadSheetLink(){
      const r=await api(`?action=sheetLink&flowKey=${encodeURIComponent(flowKey)}`);
      const a=document.getElementById('sheetBtn'); a.href=r.url; a.target="_blank";
    }

    function renderItem(item){
      const f=item.fields;
      const owners=META.owners?.length?META.owners:['ריק','חן','בלה','תמרה','ליאור','נטע'];
      const statuses=META.statuses?.length?META.statuses:['לטיפול','בעבודה','הסתיים'];

      const ownerSel=`<select class="pill owner" data-rowid="${item.rowId}">
        ${owners.map(o=>`<option${(f.owner||'ריק')===o?' selected':''}>${o}</option>`).join('')}
      </select>`;
      const statusSel=`<select class="pill status" data-rowid="${item.rowId}">
        ${statuses.map(s=>`<option${(f.status||'לטיפול')===s?' selected':''}>${s}</option>`).join('')}
      </select>`;

      return `
        <article class="card" data-rowid="${item.rowId}">
          <div class="actions" style="justify-content:space-between;margin-bottom:6px">
            <span class="pill muted">נוצר: ${f.createdAt||''}</span>
            <span class="pill muted">מס׳ תיק: ${f.caseId||''}</span>
          </div>
          <div class="actions" style="margin-bottom:8px">
            <span class="pill">מטפל: ${ownerSel}</span>
            <span class="pill">סטטוס: ${statusSel}</span>
          </div>

          <div class="kv">
            <div class="box"><div class="muted">שם</div><div>${(f.firstName||'')+' '+(f.lastName||'')}</div></div>
            <div class="box"><div class="muted">טלפון</div><div dir="ltr">${f.phone||''}</div></div>
            <div class="box"><div class="muted">תפקיד</div><div>${f.role||''}</div></div>
            <div class="box"><div class="muted">מקצוע</div><div>${f.subject||''}</div></div>
          </div>

          <div style="margin-top:10px">
            <div class="muted" style="margin-bottom:6px">הערת מנהל</div>
            <textarea class="admin-notes" data-rowid="${item.rowId}" rows="2" placeholder="כתוב הערה…" style="width:100%;padding:12px;border-radius:12px;border:1px solid #ddd">${f.adminNotes||''}</textarea>
          </div>

          <details style="margin-top:10px">
            <summary class="pill">פרטים נוספים ▾</summary>
            <div style="margin-top:10px">
              ${(f._keys||[]).map(k=>{
                if(k==='adminNotes') return '';
                const v=f[k];
                return `<div class="box" style="margin:6px 0"><div class="muted">${k}</div><div>${v==null?'':v}</div></div>`;
              }).join('')}
            </div>
          </details>

          <div class="actions" style="justify-content:flex-end;margin-top:10px">
            <button class="pill open-sheet" data-row="${item.rowId}"><i data-feather="book-open"></i> לשורה בגליון</button>
          </div>
        </article>
      `;
    }

    async function updateField(rowId, updates){
      try{
        const body={action:'updateRow', flowKey, rowId, updates, actor:'WebPanel'};
        const r=await api("",{method:'POST',body});
        if(!r.ok) throw new Error(r.error||'update failed');
        toast('נשמר ✔︎');
      }catch(e){
        alert('שגיאה בשמירה: '+e.message);
      }
    }

    async function loadColumn(which,q=''){
      const list=document.getElementById('list-'+which);
      list.innerHTML='<div class="card" style="opacity:.6">טוען…</div>';
      const data=await api(`?action=flow&flowKey=${encodeURIComponent(flowKey)}&status=${which}${q?'&q='+encodeURIComponent(q):''}`);
      list.innerHTML=(data.items||[]).map(renderItem).join('')||'<div class="card" style="opacity:.6">אין משימות להצגה</div>';
      feather.replace(list);
      return data.meta?data.meta.total:0;
    }

    function wireList(containerId){
      const el=document.getElementById(containerId);
      el.addEventListener('change',async(e)=>{
        const t=e.target; const rowId=parseInt(t.getAttribute('data-rowid'),10); if(!rowId) return;
        if(t.classList.contains('owner'))  await updateField(rowId,{owner:t.value});
        if(t.classList.contains('status')) await updateField(rowId,{status:t.value});
      });
      const timers=new Map();
      el.addEventListener('input',(e)=>{
        const t=e.target; if(!t.classList.contains('admin-notes')) return;
        const rowId=parseInt(t.getAttribute('data-rowid'),10);
        clearTimeout(timers.get(rowId));
        timers.set(rowId,setTimeout(()=>updateField(rowId,{adminNotes:t.value}),500));
      });
      el.addEventListener('click',(e)=>{
        const btn=e.target.closest('.open-sheet'); if(!btn) return;
        const base=document.getElementById('sheetBtn').href; const row=btn.getAttribute('data-row');
        if(base){ const url=new URL(base); url.searchParams.set('range','A'+row); window.open(url.toString(),'_blank'); }
      });
    }
    wireList('list-in'); wireList('list-work');

    async function loadAll(){
      const err=document.getElementById('err'); err.hidden=true; err.textContent='';
      try{
        if(!flowKey){ err.hidden=false; err.textContent='חסר flowKey ב־URL'; return; }
        await loadMeta(); await loadSheetLink();
        const q=document.getElementById('q').value.trim();
        const [inCnt,workCnt]=await Promise.all([loadColumn('in',q),loadColumn('work',q)]);
        document.getElementById('cnt-in').textContent=inCnt;
        document.getElementById('cnt-work').textContent=workCnt;
      }catch(e){ err.hidden=false; err.textContent='שגיאה בטעינה – '+e.message; }
    }
    document.getElementById('refresh-btn').addEventListener('click',loadAll);
    document.getElementById('q').addEventListener('input',()=>{ clearTimeout(window.__q); window.__q=setTimeout(loadAll,250); });

    loadAll();
  </script>
</body>
</html>