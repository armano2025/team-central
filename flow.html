<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>יוסטון – Flow</title>

  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css" />
  <script src="https://unpkg.com/feather-icons"></script>

  <style>
    /* פס כפתורים עליון – קומפקטי */
    .top-buttons {
      gap: 10px; flex-wrap: wrap; justify-content: center; margin-bottom: 10px;
    }
    .top-buttons a, .top-buttons button { padding: 8px 12px; border-radius: 10px; font-size: .95rem; }

    /* הירו – התאמות קלות */
    .hero .chips {
      display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 12px;
    }
    .chip {
      background: rgba(255,255,255,.22); color: #fff; padding: 10px 12px;
      border-radius: 999px; font-weight: 600; backdrop-filter: blur(2px);
    }
    .chip .num { font-size: 1.25rem; margin-inline-start: 6px; }

    /* אזור חיפוש */
    .toolbar {
      display: grid; grid-template-columns: 1fr auto; gap: 10px;
      max-width: 900px; margin: 8px auto 14px;
    }
    .search-input {
      background: var(--color-surface); border: none; border-radius: var(--border-radius);
      padding: 10px 12px; font-size: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,.08);
      outline: none;
    }
    .toolbar .btns { display: flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end; }

    /* שני טורים – במובייל אחד אחרי השני */
    .columns {
      display: grid; gap: 14px; grid-template-columns: 1fr; max-width: 1100px; margin: 0 auto;
    }
    @media (min-width: 900px) { .columns { grid-template-columns: 1fr 1fr; gap: 18px; } }

    .col {
      background: transparent;
    }
    .col h3 {
      text-align: right; margin: 6px 4px 10px; font-size: 1.1rem; opacity: .85;
    }

    /* כרטיסי משימות */
    .task-list { display: grid; gap: 12px; }
    .task-card {
      background: var(--color-surface);
      border-radius: var(--border-radius);
      box-shadow: 0 2px 10px rgba(0,0,0,.08);
      padding: 12px 14px; text-align: right;
    }
    .task-head {
      display:flex; justify-content: space-between; align-items: center; gap: 8px; margin-bottom: 6px;
    }
    .kvs {
      display:grid; grid-template-columns: 1fr 1fr; gap: 8px;
      font-size: .95rem;
    }
    .kv { background: rgba(0,0,0,.04); border-radius: 10px; padding: 8px; }
    .kv b { display:block; font-weight:600; opacity:.75; margin-bottom:3px; }
    .notes {
      margin-top: 8px; font-size: .95rem; opacity: .85;
    }
    .meta {
      margin-top: 8px; display: flex; gap:10px; flex-wrap: wrap; opacity:.75; font-size: .9rem;
    }
    .pill {
      background: rgba(0,0,0,.06); padding: 4px 10px; border-radius: 999px; white-space: nowrap;
    }

    details {
      margin-top: 8px; background: rgba(0,0,0,.03); border-radius: 10px; padding: 8px 10px;
    }
    details summary { cursor: pointer; font-weight: 600; }
    .full-grid {
      display: grid; gap: 6px; grid-template-columns: 1fr 1fr; margin-top: 8px;
      font-size: .9rem;
    }
    .full-grid .row { background: #fff; border-radius: 8px; padding: 6px 8px; box-shadow: 0 1px 3px rgba(0,0,0,.05); }
    .full-grid .row b { display: inline-block; min-width: 110px; opacity: .7; }

    /* רמזים */
    .empty { opacity:.6; text-align:center; padding: 18px 10px; }
  </style>
</head>
<body>

  <!-- ניווט עליון -->
  <nav class="top-buttons" aria-label="ניווט עליון">
    <a href="javascript:void(0)" onclick="history.back()" title="חזור"><i data-feather="arrow-right"></i> חזור</a>
    <a href="houston-dashboard.html" title="דאשבורד"><i data-feather="grid"></i> דאשבורד</a>
    <a href="admin.html" title="עמוד אדמין"><i data-feather="settings"></i> אדמין</a>
    <button id="refresh-btn" type="button" title="ריענון"><i data-feather="rotate-cw"></i> ריענון</button>
    <button id="finished-btn" type="button" title="הסתיימו"><i data-feather="check-circle"></i> הסתיימו</button>
    <button id="sheet-btn" type="button" title="לגליון הנתונים"><i data-feather="table"></i> לגליון</button>
    <button id="dark-toggle" type="button" title="מצב כהה / בהיר"><i data-feather="moon"></i></button>
  </nav>

  <!-- הירו -->
  <header class="hero">
    <div class="hero-content">
      <h2 id="flow-title">Flow</h2>
      <p id="flow-subtitle">תצוגת עבודה – טור "לטיפול" וטור "בעבודה".</p>
      <div class="chips">
        <div class="chip"><span class="num" id="count-in">0</span>לטיפול</div>
        <div class="chip"><span class="num" id="count-work">0</span>בעבודה</div>
      </div>
    </div>
  </header>

  <!-- חיפוש + כפתורים משניים -->
  <div class="toolbar">
    <input id="search" class="search-input" type="search" placeholder="חיפוש: שם, משפחה, טלפון, מקצוע, הערות…" />
    <div class="btns">
      <button class="top-buttons" style="padding:8px 12px" onclick="clearSearch()"><i data-feather="x"></i> נקה</button>
    </div>
  </div>

  <!-- שני טורים -->
  <main class="columns">
    <section class="col" aria-label="לטיפול">
      <h3>לטיפול</h3>
      <div id="list-in" class="task-list"></div>
    </section>

    <section class="col" aria-label="בעבודה">
      <h3>בעבודה</h3>
      <div id="list-work" class="task-list"></div>
    </section>
  </main>

  <script>
    feather.replace();

    // מצב כהה – זהה לשאר האתר
    if (localStorage.getItem('dark-mode') === '1') {
      document.documentElement.classList.add('dark-mode');
    }
    document.getElementById('dark-toggle').addEventListener('click', () => {
      const isDark = document.documentElement.classList.toggle('dark-mode');
      isDark ? localStorage.setItem('dark-mode','1') : localStorage.removeItem('dark-mode');
    });

    // === CONFIG ===
    const API_URL = "https://script.google.com/macros/s/AKfycbxagWMbWh-tmxa03Z_6Z7AQK1Hgp3G8AkcBPgvj6eYLQxBm5aNMrPB7FfEEzHp0BT0H/exec";

    // helpers
    const qs = (k, d='') => new URLSearchParams(location.search).get(k) ?? d;
    const flowKey = qs('flowKey','');

    // טעינה ראשונית
    document.getElementById('refresh-btn').addEventListener('click', loadAll);
    document.getElementById('finished-btn').addEventListener('click', () => {
      // נפתח עמוד עתידי – finished.html – עם אותו flowKey
      location.href = `finished.html?flowKey=${encodeURIComponent(flowKey)}`;
    });
    document.getElementById('sheet-btn').addEventListener('click', openSheetTab);

    // חיפוש עם debounce
    let q = '';
    const searchInput = document.getElementById('search');
    let t = null;
    searchInput.addEventListener('input', () => {
      q = searchInput.value.trim();
      clearTimeout(t);
      t = setTimeout(loadAll, 300);
    });
    function clearSearch() {
      searchInput.value = '';
      q = '';
      loadAll();
    }

    async function openSheetTab() {
      try {
        const r = await fetch(API_URL + `?action=sheetLink&flowKey=${encodeURIComponent(flowKey)}`);
        const d = await r.json();
        if (d?.url) window.open(d.url, '_blank');
      } catch (e) { console.error(e); }
    }

    async function loadAll() {
      if (!flowKey) { alert('חסר flowKey בכתובת'); return; }

      setTitle(flowKey);

      // טען שתי הרשימות במקביל
      const [inRes, workRes] = await Promise.all([
        fetch(API_URL + `?action=flow&flowKey=${encodeURIComponent(flowKey)}&status=in&q=${encodeURIComponent(q)}&limit=200`),
        fetch(API_URL + `?action=flow&flowKey=${encodeURIComponent(flowKey)}&status=work&q=${encodeURIComponent(q)}&limit=200`)
      ]);

      const [inData, workData] = await Promise.all([inRes.json(), workRes.json()]);

      // מונים בהירו
      document.getElementById('count-in').textContent = inData?.meta?.total ?? 0;
      document.getElementById('count-work').textContent = workData?.meta?.total ?? 0;

      // רינדור רשימות
      renderList('list-in', inData?.items || []);
      renderList('list-work', workData?.items || []);
    }

    function setTitle(key) {
      // שמות ידידותיים בסיסיים (כמו בקוד ה־API)
      const map = {
        info: 'פניות רישום',
        onetime: 'שיעורים חד-פעמיים',
        billing: 'בקשות תשלום',
        message: 'הודעות כלליות',
        boost: 'שיעורי תגבור',
        reschedule: 'שינוי מועד',
        makeup: 'שיעור השלמה',
        cancel: 'ביטול שיעור'
      };
      document.getElementById('flow-title').textContent = map[key] || key;
      document.getElementById('flow-subtitle').textContent = 'תצוגת עבודה – טור "לטיפול" וטור "בעבודה".';
    }

    function renderList(elId, items) {
      const el = document.getElementById(elId);
      if (!items.length) { el.innerHTML = `<div class="empty">אין משימות להצגה</div>`; return; }
      el.innerHTML = items.map(renderCard).join('');
    }

    function renderCard(item) {
      const f = item.fields || {};
      const fullName = [f.firstName, f.lastName].filter(Boolean).join(' ');
      const role = f.role || '';
      const phone = f.phone || '';
      const subject = f.subject || '';
      const createdAt = f.createdAt || '';
      const owner = f.owner || 'ריק';
      const adminNotes = f.adminNotes || f['admin notes'] || '';

      // בלוקי מידע עיקריים (מוצגים רק אם קיימים)
      const kvs = [
        fullName ? kv('שם', fullName) : '',
        phone ? kv('טלפון', phone) : '',
        subject ? kv('מקצוע', subject) : '',
        role ? kv('תפקיד', role) : '',
      ].join('');

      // גריד מלא של כל השדות (ב־details)
      const allRows = (f._keys || Object.keys(f)).map(k => {
        if (k === '_keys') return '';
        return `<div class="row"><b>${escapeHtml(k)}:</b> ${escapeHtml(f[k])}</div>`;
      }).join('');

      return `
        <article class="task-card">
          <div class="task-head">
            <div class="meta">
              <span class="pill">מטפל: ${escapeHtml(owner)}</span>
              ${createdAt ? `<span class="pill">נוצר: ${escapeHtml(createdAt)}</span>` : ''}
            </div>
          </div>

          ${kvs ? `<div class="kvs">${kvs}</div>` : ''}

          ${adminNotes ? `<div class="notes"><b>הערת מנהל:</b> ${escapeHtml(adminNotes)}</div>` : ''}

          <details>
            <summary>פרטים נוספים</summary>
            <div class="full-grid">${allRows}</div>
          </details>
        </article>
      `;
    }

    function kv(label, value) {
      return `<div class="kv"><b>${escapeHtml(label)}</b><div>${escapeHtml(value)}</div></div>`;
    }

    function escapeHtml(v) {
      return String(v ?? '')
        .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    }

    // הפעלה
    loadAll();
  </script>
</body>
</html>