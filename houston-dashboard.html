<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>יוסטון דאשבורד</title>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css" />
  <script src="https://unpkg.com/feather-icons"></script>
  <style>
    .hero .chips{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
    .chip{background:rgba(255,255,255,.22);color:#fff;padding:10px 12px;border-radius:999px;font-weight:600}
    .chip .num{font-size:1.25rem;margin-inline-start:6px}
    .cards-grid{grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:14px}
    .flow-card-header{display:flex;align-items:flex-start;justify-content:space-between;gap:8px;margin-bottom:8px;width:100%}
    .flow-title{font-weight:700;line-height:1.2;font-size:1.05rem}
    .badge{display:inline-block;background:rgba(0,0,0,0.06);padding:4px 10px;border-radius:999px;font-size:.85rem;white-space:nowrap}
  </style>
</head>
<body>
  <nav class="top-buttons">
    <a href="javascript:void(0)" onclick="history.back()"><i data-feather="arrow-right"></i> חזור</a>
    <a href="admin.html"><i data-feather="settings"></i> אדמין</a>
    <button id="refresh-btn" type="button" title="ריענון"><i data-feather="rotate-cw"></i> ריענון</button>
    <button id="dark-toggle" type="button" title="מצב כהה/בהיר"><i data-feather="moon"></i></button>
  </nav>

  <header class="hero">
    <div class="hero-content">
      <h2>יוסטון<br/>דאשבורד</h2>
      <p>סקירה מהירה של כל הזרימות והפניות—במקום אחד.</p>
      <div class="chips">
        <div class="chip"><span class="num" id="total-in">0</span>סה״כ לטיפול</div>
        <div class="chip"><span class="num" id="total-work">0</span>סה״כ בעבודה</div>
      </div>
    </div>
  </header>

  <section id="flows" class="cards-grid" aria-label="כרטיסיות זרימה"></section>

  <script>
    feather.replace();
    const API_URL = "https://script.google.com/macros/s/AKfycbxagWMbWh-tmxa03Z_6Z7AQK1Hgp3G8AkcBPgvj6eYLQxBm5aNMrPB7FfEEzHp0BT0H/exec";

    // מצב כהה
    (function(){
      const r=document.documentElement;
      if(localStorage.getItem('dark-mode')==='1') r.classList.add('dark-mode');
      document.getElementById('dark-toggle').addEventListener('click', ()=>{ const on=r.classList.toggle('dark-mode'); on?localStorage.setItem('dark-mode','1'):localStorage.removeItem('dark-mode'); });
    })();

    async function api(path){ const res=await fetch(API_URL+path); if(!res.ok) throw new Error('HTTP '+res.status); const j=await res.json(); if(j.ok===false) throw new Error(j.error||'API'); return j; }

    async function loadDashboard(){
      const container=document.getElementById('flows');
      container.innerHTML='<div class="card" style="opacity:.6">טוען…</div>';
      try{
        const data=await api("?action=dashboard");
        const totals=data.flows.reduce((a,f)=>({in:a.in+(f.counts?.in||0), work:a.work+(f.counts?.work||0)}),{in:0,work:0});
        document.getElementById('total-in').textContent=totals.in;
        document.getElementById('total-work').textContent=totals.work;

        container.innerHTML = data.flows.map(f=>`
          <a class="card" href="flow.html?flowKey=${encodeURIComponent(f.flowKey)}" title="${f.friendlyName}">
            <div class="flow-card-header">
              <div class="flow-title">${f.friendlyName}</div>
              <div>
                <span class="badge">לטיפול: ${f.counts.in}</span>
                <span class="badge">בעבודה: ${f.counts.work}</span>
              </div>
            </div>
            <div class="hint">כניסה לניהול ה־Flow →</div>
          </a>
        `).join('');
      }catch(e){
        container.innerHTML='<div class="card" style="opacity:.9;color:#b00020">שגיאה בטעינה</div>';
      }
    }
    document.getElementById('refresh-btn').addEventListener('click',loadDashboard);
    loadDashboard();
  </script>
</body>
</html>