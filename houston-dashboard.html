<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>יוסטון דאשבורד</title>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css" />
  <script src="https://unpkg.com/feather-icons"></script>

  <!-- תוספות עיצוב מינימליות עבור Option C -->
  <style>
    /* KPI chips בתוך ההירו */
    .hero .chips{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
    .chip{background:rgba(255,255,255,.22);color:#fff;padding:10px 12px;border-radius:999px;font-weight:600}
    .chip .num{font-size:1.25rem;margin-inline-start:6px}

    /* ===== Work Queue (רשימת משימות) ===== */
    .queue{max-width:980px;margin:16px auto 8px}
    .queue-head{display:flex;align-items:center;gap:8px;margin:0 12px 8px}
    .queue-head h3{margin:0;font-size:1.05rem;font-weight:800}
    .queue-list{display:flex;flex-direction:column;gap:10px;padding:0 12px}
    .queue-item{
      display:flex;align-items:center;gap:12px;
      background:var(--card, #fff); border:1px solid var(--glass-brd,#e8eef7);
      border-radius:14px; padding:12px 12px; text-decoration:none; color:inherit;
      box-shadow:0 8px 22px rgba(15,23,42,.06);
      transition:transform .15s ease, box-shadow .15s ease, border-color .15s ease;
    }
    .queue-item:hover,.queue-item:focus-visible{
      transform:translateY(-1px);
      border-color:#cbd5e1; outline:none;
      box-shadow:0 14px 36px rgba(15,23,42,.10);
    }
    .qi-bar{width:6px;align-self:stretch;border-radius:10px}
    .qi-icon{display:inline-flex;align-items:center;justify-content:center;min-width:28px;height:28px;border-radius:8px;background:var(--chip,#f1f5f9);border:1px solid var(--chip-brd,#e2e8f0)}
    .qi-body{display:flex;align-items:center;gap:10px;flex:1;min-width:0}
    .qi-title{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .qi-meta{display:flex;gap:6px;align-items:center;margin-inline-start:auto;white-space:nowrap}
    .badge{display:inline-block;background:rgba(0,0,0,0.06);padding:4px 10px;border-radius:999px;font-size:.85rem;white-space:nowrap}
    .qi-arrow{opacity:.7}

    /* צבעים לפי סוג */
    .bar-makeup{background:linear-gradient(180deg,#60a5fa,#93c5fd)}
    .bar-reschedule{background:linear-gradient(180deg,#34d399,#a7f3d0)}
    .bar-boost{background:linear-gradient(180deg,#f59e0b,#fde68a)}
    .bar-billing{background:linear-gradient(180deg,#22c55e,#86efac)}
    .bar-message{background:linear-gradient(180deg,#a78bfa,#ddd6fe)}
    .bar-cancel{background:linear-gradient(180deg,#f87171,#fecaca)}

    /* גריד הקטגוריות מתחת */
    .cards-grid{grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:14px}
    .flow-card-header{display:flex;align-items:flex-start;justify-content:space-between;gap:8px;margin-bottom:8px;width:100%}
    .flow-title{font-weight:700;line-height:1.2;font-size:1.05rem}
    .hint{opacity:.75}
  </style>
</head>
<body>
  <nav class="top-buttons">
    <a href="javascript:void(0)" onclick="history.back()"><i data-feather="arrow-right"></i> חזור</a>
    <a href="admin.html"><i data-feather="settings"></i> אדמין</a>
    <button id="refresh-btn" type="button" title="ריענון"><i data-feather="rotate-cw"></i> ריענון</button>
    <button id="dark-toggle" type="button" title="מצב כהה/בהיר"><i data-feather="moon"></i></button>
  </nav>

  <header class="hero">
    <div class="hero-content">
      <h2>יוסטון<br/>דאשבורד</h2>
      <p>סקירה מהירה של כל הזרימות והפניות—במקום אחד.</p>
      <div class="chips">
        <div class="chip"><span class="num" id="total-in">0</span>סה״כ לטיפול</div>
        <div class="chip"><span class="num" id="total-work">0</span>סה״כ בעבודה</div>
      </div>
    </div>
  </header>

  <!-- ===== Work Queue (רשימת משימות מובילה) ===== -->
  <section class="queue" aria-label="רשימת משימות">
    <div class="queue-head">
      <h3>תור עבודה</h3>
      <span class="meta muted" id="queue-sub"></span>
    </div>
    <div id="queue-list" class="queue-list" role="list"></div>
  </section>

  <!-- ===== Grid של קטגוריות מתחת ===== -->
  <section id="flows" class="cards-grid" aria-label="כרטיסיות זרימה"></section>

  <script>
    feather.replace();

    const API_URL = "https://script.google.com/macros/s/AKfycbxagWMbWh-tmxa03Z_6Z7AQK1Hgp3G8AkcBPgvj6eYLQxBm5aNMrPB7FfEEzHp0BT0H/exec";

    // מצב כהה
    (function(){
      const r=document.documentElement;
      if(localStorage.getItem('dark-mode')==='1') r.classList.add('dark-mode');
      document.getElementById('dark-toggle').addEventListener('click', ()=>{
        const on=r.classList.toggle('dark-mode');
        on?localStorage.setItem('dark-mode','1'):localStorage.removeItem('dark-mode');
      });
    })();

    async function api(path){
      const res=await fetch(API_URL+path);
      if(!res.ok) throw new Error('HTTP '+res.status);
      const j=await res.json();
      if(j.ok===false) throw new Error(j.error||'API');
      return j;
    }

    // מיפוי צבע/אייקון לפי flowKey (נופל חזרה לברירת מחדל)
    const FLOW_STYLE = {
      makeup:     { bar:'bar-makeup',     icon:'calendar',     label:'השלמת שיעור' },
      reschedule: { bar:'bar-reschedule', icon:'repeat',       label:'שינוי קבוע' },
      boost:      { bar:'bar-boost',      icon:'trending-up',  label:'שיעור תגבור' },
      billing:    { bar:'bar-billing',    icon:'credit-card',  label:'עדכון תשלום' },
      message:    { bar:'bar-message',    icon:'mail',         label:'הודעה' },
      cancel:     { bar:'bar-cancel',     icon:'slash',        label:'ביטול מנוי' },
    };
    const styleFor = (key) => {
      const k = (key||'').toLowerCase();
      for (const name of Object.keys(FLOW_STYLE)){
        if (k.includes(name)) return FLOW_STYLE[name];
      }
      return { bar:'bar-message', icon:'file-text', label:'' };
    };

    function makeQueueItem(f){
      const s = styleFor(f.flowKey);
      // מספר “לטיפול” קובע דחיפות; אם אפס – לא ייכנס לתור
      const inNum = f.counts?.in ?? 0;
      const workNum = f.counts?.work ?? 0;
      return `
        <a class="queue-item" href="flow.html?flowKey=${encodeURIComponent(f.flowKey)}" role="listitem" title="${f.friendlyName}">
          <div class="qi-bar ${s.bar}" aria-hidden="true"></div>
          <div class="qi-icon" aria-hidden="true"><i data-feather="${s.icon}"></i></div>
          <div class="qi-body">
            <div class="qi-title">${f.friendlyName}</div>
            <div class="qi-meta">
              <span class="badge">לטיפול: ${inNum}</span>
              <span class="badge">בעבודה: ${workNum}</span>
              <span class="qi-arrow"><i data-feather="chevron-left"></i></span>
            </div>
          </div>
        </a>
      `;
    }

    async function loadDashboard(){
      const flowsEl = document.getElementById('flows');
      const queueEl = document.getElementById('queue-list');
      const subEl   = document.getElementById('queue-sub');

      flowsEl.innerHTML = '<div class="card" style="opacity:.6">טוען…</div>';
      queueEl.innerHTML = '<div class="card" style="opacity:.6">טוען…</div>';

      try{
        const data = await api("?action=dashboard");

        // Totals ל-Hero
        const totals = data.flows.reduce((a,f)=>({
          in:   a.in   + (f.counts?.in   || 0),
          work: a.work + (f.counts?.work || 0)
        }), {in:0, work:0});
        document.getElementById('total-in').textContent   = totals.in;
        document.getElementById('total-work').textContent = totals.work;

        // ===== Work Queue: ממויין לפי “לטיפול” ואז “בעבודה” =====
        const queueData = [...data.flows]
          .filter(f => (f.counts?.in||0) > 0)   // רק מה שבאמת “ממתין”
          .sort((a,b) => (b.counts.in - a.counts.in) || (b.counts.work - a.counts.work))
          .slice(0, 6); // תור קצר ונקי

        if (queueData.length === 0){
          queueEl.innerHTML = `<div class="card" style="text-align:center">אין פריטים בתור כרגע. תענוג! 👨‍🚀</div>`;
          subEl.textContent = '';
        } else {
          subEl.textContent = `מציג ${queueData.length} זרימות עם פריטים ממתינים`;
          queueEl.innerHTML = queueData.map(makeQueueItem).join('');
          // רענון אייקונים של Feather שנכנסו דינמית
          feather.replace();
        }

        // ===== Grid של כל הזרימות (כמו שהיה) =====
        flowsEl.innerHTML = data.flows.map(f=>`
          <a class="card" href="flow.html?flowKey=${encodeURIComponent(f.flowKey)}" title="${f.friendlyName}">
            <div class="flow-card-header">
              <div class="flow-title">${f.friendlyName}</div>
              <div>
                <span class="badge">לטיפול: ${f.counts.in}</span>
                <span class="badge">בעבודה: ${f.counts.work}</span>
              </div>
            </div>
            <div class="hint">כניסה לניהול ה־Flow →</div>
          </a>
        `).join('');
      }catch(e){
        const err = '<div class="card" style="opacity:.9;color:#b00020">שגיאה בטעינה</div>';
        flowsEl.innerHTML = err;
        queueEl.innerHTML = err;
      }
    }

    document.getElementById('refresh-btn').addEventListener('click',loadDashboard);
    loadDashboard();
  </script>
</body>
</html>