<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>×œ×•×’ ×”×©×œ×™×—×•×ª â€“ ×‘×¨××•× ×©×˜×™×™×Ÿ</title>
  <link rel="stylesheet" href="styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet" />
  <script src="https://unpkg.com/feather-icons"></script>
</head>
<body>

  <div class="top-buttons">
    <button id="refreshBtn"><i data-feather="refresh-cw"></i> ×¨×¢× ×Ÿ</button>
    <a href="send-message.html"><i data-feather="arrow-right-circle"></i> ×—×–×•×¨</a>
  </div>

  <section class="hero">
    <div class="hero-content">
      <h2>×œ×•×’ ×”×©×œ×™×—×•×ª</h2>
      <p>×›××Ÿ ×ª×•×›×œ ×œ×¢×§×•×‘ ××—×¨ ×›×œ ×”×”×•×“×¢×•×ª ×©× ×©×œ×—×• ××”××¢×¨×›×ª.</p>
    </div>
  </section>

  <div class="top-buttons" style="justify-content: center;">
    <input type="text" id="searchInput" placeholder="×—×¤×© ×œ×¤×™ ×©× ××• ×˜×œ×¤×•×Ÿ" style="padding: 8px; border-radius: 8px; border: 1px solid #ccc;" />
    <select id="statusFilter" style="padding: 8px; border-radius: 8px; margin-right: 12px;">
      <option value="">×”×¦×’ ×”×›×œ</option>
      <option value="×”×¦×œ×—×”">×¨×§ ×”×¦×œ×—×•×ª</option>
      <option value="× ×›×©×œ">×¨×§ ×›×™×©×œ×•× ×•×ª</option>
    </select>
    <button id="downloadCSV"><i data-feather="download"></i> ×”×•×¨×“ CSV</button>
  </div>

  <div id="status" style="text-align:center; margin-top: 1rem;">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>
  <div id="cardsContainer" class="cards-grid" style="margin-top: 2rem;"></div>

  <script>
    let allData = [];

    async function loadLog() {
      const container = document.getElementById("cardsContainer");
      const statusEl = document.getElementById("status");
      try {
        const res = await fetch("https://script.google.com/macros/s/AKfycbw9WvZCTYDjqpWQf6H_Y8Mpl2dgRxhJD5Aqm5RkA6ICbpt3Si7rgJG3A10NctHpsK0S7A/exec");
        const data = await res.json();
        allData = data.reverse(); // ×”×¦×’×” ×œ×¤×™ ×”××—×¨×•×Ÿ ×¨××©×•×Ÿ
        renderCards(allData);
        statusEl.style.display = "none";
      } catch (err) {
        statusEl.innerHTML = "âš ï¸ ×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×.";
        console.error(err);
      }
    }

    function renderCards(data) {
      const container = document.getElementById("cardsContainer");
      container.innerHTML = "";
      if (data.length === 0) {
        container.innerHTML = "<p>×œ× × ××¦××• ×ª×•×¦××•×ª ×ª×•×××•×ª.</p>";
        return;
      }

      data.forEach(row => {
        const card = document.createElement("div");
        card.className = "card";
        if (row.status === "× ×›×©×œ") {
          card.style.backgroundColor = "#ffe9e9";
        }
        card.innerHTML = `
          <h3>${row.firstName || ''} ${row.lastName || ''}</h3>
          <p><strong>ğŸ“</strong> ${row.phone || ''}</p>
          <p><strong>ğŸ•’</strong> ${row.time || ''}</p>
          <p><strong>×”×•×“×¢×”:</strong><br>${row.message || ''}</p>
          <p><strong>×¡×˜×˜×•×¡:</strong> ${row.status || ''}</p>
        `;
        container.appendChild(card);
      });
    }

    function filterData() {
      const search = document.getElementById("searchInput").value.trim().toLowerCase();
      const status = document.getElementById("statusFilter").value;
      const filtered = allData.filter(row => {
        const fullName = `${row.firstName} ${row.lastName}`.toLowerCase();
        const phone = (row.phone || "").toLowerCase();
        const statusMatch = status === "" || row.status === status;
        return (fullName.includes(search) || phone.includes(search)) && statusMatch;
      });
      renderCards(filtered);
    }

    function downloadCSV() {
      const status = document.getElementById("statusFilter").value;
      const search = document.getElementById("searchInput").value.trim().toLowerCase();
      const filtered = allData.filter(row => {
        const fullName = `${row.firstName} ${row.lastName}`.toLowerCase();
        const phone = (row.phone || "").toLowerCase();
        const statusMatch = status === "" || row.status === status;
        return (fullName.includes(search) || phone.includes(search)) && statusMatch;
      });

      const csvRows = [
        ["×©× ×¤×¨×˜×™", "×©× ××©×¤×—×”", "×˜×œ×¤×•×Ÿ", "×”×•×“×¢×”", "×–××Ÿ", "×¡×˜×˜×•×¡"],
        ...filtered.map(r => [r.firstName, r.lastName, r.phone, r.message, r.time, r.status])
      ];
      const csvContent = csvRows.map(row => row.map(field => `"${field}"`).join(",")).join("\n");
      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "log.csv";
      link.click();
    }

    document.getElementById("searchInput").addEventListener("input", filterData);
    document.getElementById("statusFilter").addEventListener("change", filterData);
    document.getElementById("refreshBtn").addEventListener("click", () => loadLog());
    document.getElementById("downloadCSV").addEventListener("click", downloadCSV);

    window.onload = () => {
      feather.replace();
      loadLog();
    };
  </script>

</body>
</html>