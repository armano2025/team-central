<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>לוג השליחות – בראונשטיין</title>
  <link rel="stylesheet" href="styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet" />
  <script src="https://unpkg.com/feather-icons"></script>
</head>
<body>

  <div class="top-buttons">
    <button id="refreshBtn"><i data-feather="refresh-cw"></i> רענן</button>
    <a href="send-message.html"><i data-feather="arrow-right-circle"></i> חזור</a>
  </div>

  <section class="hero">
    <div class="hero-content">
      <h2>לוג השליחות</h2>
      <p>כאן תוכל לעקוב אחר כל ההודעות שנשלחו מהמערכת.</p>
    </div>
  </section>

  <div class="top-buttons" style="justify-content: center;">
    <input type="text" id="searchInput" placeholder="חפש לפי שם או טלפון" style="padding: 8px; border-radius: 8px; border: 1px solid #ccc;" />
    <select id="statusFilter" style="padding: 8px; border-radius: 8px; margin-right: 12px;">
      <option value="">הצג הכל</option>
      <option value="הצלחה">הצלחה</option>
      <option value="נכשל">נכשל</option>
    </select>
    <button id="downloadCSV"><i data-feather="download"></i> הורד CSV</button>
  </div>

  <div id="status" style="text-align:center; margin-top: 1rem;">טוען נתונים...</div>
  <div id="cardsContainer" class="cards-grid" style="margin-top: 2rem;"></div>

  <script>
    let allData = [];

    async function loadLog() {
      const container = document.getElementById("cardsContainer");
      const statusEl = document.getElementById("status");
      try {
        const res = await fetch("https://script.google.com/macros/s/AKfycbw9WvZCTYDjqpWQf6H_Y8Mpl2dgRxhJD5Aqm5RkA6ICbpt3Si7rgJG3A10NctHpsK0S7A/exec");
        const json = await res.json();

        // בדיקה גמישה: האם המידע הוא מערך? האם יש מפתחות?
        if (!Array.isArray(json)) throw new Error("הפורמט של המידע אינו תקין");

        // הפוך את הסדר: אחרון ראשון
        allData = json.reverse();

        renderCards(allData);
        statusEl.style.display = "none";
      } catch (err) {
        statusEl.innerHTML = "⚠️ שגיאה בטעינת הנתונים.";
        console.error(err);
      }
    }

    function renderCards(data) {
      const container = document.getElementById("cardsContainer");
      container.innerHTML = "";

      if (!data || data.length === 0) {
        container.innerHTML = "<p>לא נמצאו תוצאות תואמות.</p>";
        return;
      }

      data.forEach(row => {
        const card = document.createElement("div");
        card.className = "card";
        if ((row.status || "").trim() === "נכשל") {
          card.style.backgroundColor = "#ffe9e9";
        }

        card.innerHTML = `
          <h3>${row.firstName || ''} ${row.lastName || ''}</h3>
          <p><strong>📞</strong> ${row.phone || ''}</p>
          <p><strong>🕒</strong> ${row.time || ''}</p>
          <p><strong>הודעה:</strong><br>${row.message || ''}</p>
          <p><strong>סטטוס:</strong> ${row.status || ''}</p>
        `;
        container.appendChild(card);
      });
    }

    function filterAndRender() {
      const searchVal = document.getElementById("searchInput").value.trim().toLowerCase();
      const statusVal = document.getElementById("statusFilter").value;

      const filtered = allData.filter(row => {
        const fullName = `${row.firstName || ''} ${row.lastName || ''}`.toLowerCase();
        const phone = (row.phone || '').toLowerCase();
        const status = (row.status || '');
        return (fullName.includes(searchVal) || phone.includes(searchVal)) &&
               (statusVal === "" || status === statusVal);
      });

      renderCards(filtered);
    }

    function downloadCSV() {
      const statusVal = document.getElementById("statusFilter").value;
      const searchVal = document.getElementById("searchInput").value.trim().toLowerCase();

      const filtered = allData.filter(row => {
        const fullName = `${row.firstName || ''} ${row.lastName || ''}`.toLowerCase();
        const phone = (row.phone || '').toLowerCase();
        const status = (row.status || '');
        return (fullName.includes(searchVal) || phone.includes(searchVal)) &&
               (statusVal === "" || status === statusVal);
      });

      const csvHeader = ['שם פרטי','שם משפחה','טלפון','הודעה','זמן','סטטוס'];
      const csvRows = filtered.map(r => [
        r.firstName || '',
        r.lastName || '',
        r.phone || '',
        r.message || '',
        r.time || '',
        r.status || ''
      ]);
      const allRows = [csvHeader, ...csvRows];

      const csvContent = allRows.map(row => row.map(val => `"${val}"`).join(",")).join("\n");
      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.setAttribute("download", "log.csv");
      link.click();
    }

    document.getElementById("searchInput").addEventListener("input", filterAndRender);
    document.getElementById("statusFilter").addEventListener("change", filterAndRender);
    document.getElementById("refreshBtn").addEventListener("click", loadLog);
    document.getElementById("downloadCSV").addEventListener("click", downloadCSV);

    window.onload = () => {
      feather.replace();
      loadLog();
    };
  </script>

</body>
</html>