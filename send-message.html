<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>בראונשטיין – שליחת הודעה</title>
  <meta name="description" content="שליחת הודעות חכמות לתלמידים מסוננים." />
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css" />
  <link rel="manifest" href="icons/site.webmanifest" />
  <meta name="theme-color" content="#3498db" />
  <script src="https://unpkg.com/feather-icons"></script>
</head>
<body>
  <!-- כפתורי ניווט עליונים -->
  <div class="top-buttons">
    <a href="index.html"><i data-feather="home"></i> בית</a>
    <button class="menu-toggle" onclick="toggleMenu()"><i data-feather="menu"></i></button>
    <div id="dropdownMenu" class="dropdown-menu">
      <button id="share-button"><i data-feather="share-2"></i> שתף</button>
      <button id="dark-toggle"><i data-feather="moon"></i> מצב כהה</button>
    </div>
  </div>

  <header class="hero">
    <div class="hero-content">
      <h2>שליחת הודעה חכמה</h2>
      <p>הודעה לכל התלמידים המסוננים</p>
    </div>
  </header>

  <main>
    <div class="container">
      <div id="recipients">טוען נמענים...</div>

      <label for="message">תוכן ההודעה:</label>
      <textarea id="message" placeholder="כתוב כאן את ההודעה שברצונך לשלוח..."></textarea>

      <div class="top-buttons" style="justify-content: center; flex-wrap: wrap;">
        <button onclick="sendMessage()" class="send"><i data-feather="send"></i> שלח הודעה</button>
        <button onclick="resetList()" class="table-names"><i data-feather="trash-2"></i> איפוס רשימה</button>
        <button onclick="window.open('https://docs.google.com/spreadsheets/d/11_Vq5eYiadlpa-9TJ5EVpv38SjHIrlnraAFNKgZ5OwM/edit?usp=drivesdk','_blank')" class="table-names">
          <i data-feather="database"></i> טבלת שמות
        </button>
        <button onclick="window.open('https://meaningfullearning.origami.ms/-/%D7%9C%D7%9E%D7%99%D7%93%D7%94-%D7%9E%D7%A9%D7%9E%D7%A2%D7%95%D7%AA%D7%99%D7%AA/%D7%A9%D7%99%D7%A2%D7%95%D7%A8-%D7%A4%D7%A8-%D7%AA%D7%9C%D7%9E%D7%99%D7%93','_blank')" class="table-names">
          <i data-feather="download-cloud"></i> משוך רשימת שמות
        </button>
        <button onclick="window.location.href='logs.html'" class="logs">
          <i data-feather="file-text"></i> לוג שליחות
        </button>
      </div>

      <div id="status"></div>
    </div>
  </main>

  <script>
    // טען את Feather Icons
    feather.replace();

    // טעינת נמענים
    async function loadRecipients() {
      const res = await fetch("https://script.google.com/macros/s/AKfycbzKPI4Igbd2B4OppKAstXJm-TMtxirh8qAjhSm3loQ-b1SV-oicGrBTsueCUV7jYhZ9/exec?action=getRecipients");
      const data = await res.json();
      const list = data.recipients;
      if (list.length === 0) {
        document.getElementById("recipients").innerHTML = "לא נמצאו נמענים.";
        return;
      }
      document.getElementById("recipients").innerHTML =
        "<strong>נמענים:</strong><br>" +
        list.map(r => `${r.firstName} ${r.lastName} (${r.phone})`).join("<br>");
    }

    // שליחת הודעה
    async function sendMessage() {
      const msg = document.getElementById("message").value.trim();
      if (!msg) {
        alert("אנא כתוב תוכן הודעה לפני השליחה.");
        return;
      }
      const confirmSend = confirm("האם אתה בטוח שברצונך לשלוח את ההודעה לכל הנמענים?");
      if (!confirmSend) return;

      document.getElementById("status").innerHTML = "שולח הודעות...";

      const res = await fetch("https://hook.eu2.make.com/sztfzmeero425mfxirbvjsrw8yfohrke", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: msg })
      });

      if (res.ok) {
        document.getElementById("status").innerHTML = "✔️ ההודעות נשלחו בהצלחה.";
      } else {
        document.getElementById("status").innerHTML = "❌ שגיאה בשליחה.";
      }
    }

    // איפוס רשימה
    async function resetList() {
      const confirmReset = confirm("האם אתה בטוח שברצונך למחוק את כל השורות בטבלת השמות?");
      if (!confirmReset) return;

      const res = await fetch("https://script.google.com/macros/s/AKfycbzKPI4Igbd2B4OppKAstXJm-TMtxirh8qAjhSm3loQ-b1SV-oicGrBTsueCUV7jYhZ9/exec?action=reset");
      if (res.ok) {
        document.getElementById("status").innerHTML = "✔️ הרשימה אופסה בהצלחה.";
        document.getElementById("recipients").innerHTML = "אין נמענים להצגה.";
      } else {
        document.getElementById("status").innerHTML = "❌ שגיאה באיפוס הרשימה.";
      }
    }

    // תפריט קטן (לא חובה אם אין תפריט נפתח)
    function toggleMenu() {
      const menu = document.getElementById("dropdownMenu");
      menu.style.display = (menu.style.display === "block") ? "none" : "block";
    }

    // טעינה אוטומטית
    window.onload = loadRecipients;
  </script>
</body>
</html>