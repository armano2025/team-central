<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>משימות – בעלים</title>

  <link rel="stylesheet" href="../styles.css" />
  <link rel="stylesheet" href="./tasks.css" />
  <meta name="theme-color" content="#2563eb" />

  <style>
    /* ====== טעינה (skeleton) ====== */
    .loader-wrap { margin: 16px 0; display:none; }
    .skeleton {
      position: relative; overflow: hidden;
      background: #f3f4f6; border-radius: 12px; height: 72px;
      border: 1px solid #eee;
    }
    .skeleton + .skeleton { margin-top: 10px; }
    .skeleton::after {
      content: ""; position: absolute; inset: 0;
      transform: translateX(-100%);
      background-image: linear-gradient(90deg, rgba(255,255,255,0) 0%,
        rgba(255,255,255,.5) 50%, rgba(255,255,255,0) 100%);
      animation: shimmer 1.2s infinite;
    }
    @keyframes shimmer { 100% { transform: translateX(100%); } }

    /* הודעת שגיאה */
    .error-card {
      border:1px solid #ef4444; color:#ef4444; background:#fff;
      padding:14px; border-radius:12px; margin:16px 0;
    }
  </style>
</head>
<body>

  <!-- פס טעינה עליון -->
  <div id="topLoader" class="top-loader" hidden></div>

  <!-- חזרה לאדמין -->
  <a class="back-link" href="../admin.html">← חזרה למסך אדמין</a>

  <!-- HERO -->
  <header class="hero">
    <div class="hero-content">
      <h2 id="ownerTitle">משימות</h2>

      <!-- ספינר בתוך ההירו -->
      <div id="ownerHeroSpinner" class="hero-spinner" hidden aria-live="polite" aria-label="טוען נתונים">
        <span class="hero-dot"></span><span class="hero-dot"></span><span class="hero-dot"></span>
      </div>

      <!-- סטטיסטיקות לפי הדף הנוכחי (owner/status) -->
      <div class="stats" id="ownerHeroStats" hidden>
        <a class="stat-link" id="linkOwnerTodo" href="#" data-show-spinner>
          <span class="stat-pill">לטיפול: <strong id="ownerStatTodo">–</strong></span>
        </a>
        <a class="stat-link" id="linkOwnerInp" href="#" data-show-spinner>
          <span class="stat-pill">בתהליך: <strong id="ownerStatInp">–</strong></span>
        </a>
      </div>

      <div class="actions" style="margin-top:10px;">
        <button id="btnOwnerRefresh" class="btn ghost" type="button">רענן</button>
      </div>
    </div>
  </header>

  <!-- חיפוש + פילטרים -->
  <header class="page-header">
    <div class="container">
      <div class="search-wrap" role="search" aria-label="חיפוש משימות">
        <input id="ownerSearch" type="search" placeholder="חפש לפי שם / טלפון / נושא / caseId…" />
        <button id="btnOwnerSearch" class="btn">סנן</button>
        <button id="btnOwnerClear" class="btn ghost" type="button">נקה</button>
      </div>
      <div id="ownerStats" class="muted" style="margin-top:8px;">
        לטיפול: 0 | בתהליך: 0 | בוצע: 0 | בוטל: 0
      </div>
    </div>
  </header>

  <main class="container">
    <!-- טעינה -->
    <div id="loader" class="loader-wrap">
      <div class="skeleton"></div>
      <div class="skeleton"></div>
      <div class="skeleton"></div>
    </div>

    <!-- שגיאה -->
    <div id="errBox" class="error-card" style="display:none;">
      שגיאת טעינה מהשרת. בדוק/י את כתובת ה-API או את החיבור לרשת.
    </div>

    <!-- רשימת משימות -->
    <section id="tasksList" class="results-list"></section>
  </main>

  <!-- מודאל עריכת משימה -->
  <dialog id="taskDialog">
    <form method="dialog" id="taskForm" class="card">
      <h3 id="dlgTitle">משימה</h3>

      <div class="grid-2">
        <label>סטטוס
          <select id="f_status">
            <option>לטיפול</option>
            <option>בתהליך</option>
            <option>בוצע</option>
            <option>בוטל</option>
          </select>
        </label>
        <label>מטפל
          <select id="f_owner">
            <option value="">לא משויך</option>
            <option>חן</option>
            <option>תמרה</option>
            <option>בלה</option>
            <option>ליאור</option>
            <option>נטע</option>
          </select>
        </label>
      </div>

      <div class="grid-2">
        <label>שם
          <input id="f_name" type="text" disabled />
        </label>
        <label>טלפון
          <input id="f_phone" type="text" disabled />
        </label>
      </div>

      <label>הערות אדמין
        <textarea id="f_notes" rows="5" placeholder="רשום כאן הערות לניהול פנימי…"></textarea>
      </label>

      <div class="actions">
        <button type="button" id="btnSave" class="btn primary">שמירה</button>
        <button id="btnClose" class="btn ghost">סגור</button>
      </div>
      <input type="hidden" id="f_caseId" />
    </form>
  </dialog>

  <script src="./owner.js?v=13"></script>
  <script>
    // הצגת ספינר ההירו מיידית בעת לחיצה על פילי הסטטוס
    const ohs = document.getElementById('ownerHeroSpinner');
    document.querySelectorAll('[data-show-spinner]').forEach(a=>{
      a.addEventListener('click', ()=> { if (ohs) ohs.hidden = false; });
    });
  </script>
</body>
</html>